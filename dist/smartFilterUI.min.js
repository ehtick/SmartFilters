var SFUI;(()=>{"use strict";var t={d:(e,i)=>{for(var a in i)t.o(i,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:i[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{SmartFilterEditor:()=>i,SmartFilterManagerUI:()=>a,SmartPropertiesUI:()=>r,getVersion:()=>l});class i{static _chainSkip=0;static _showLimitOption=!0;static _htmlEncode(t){return(t=$.trim(t)).replace(/[&"'\<\>]/g,(function(t){switch(t){case"&":return"&amp;";case"'":return"&#39;";case'"':return"&quot;";case"<":return"&lt;";default:return"&gt;"}}))}static initialize(t,e,a){i.ctrlPressed=!1,$(document).on("keyup keydown",(function(t){i.ctrlPressed=t.ctrlKey})),i._maindiv=t,i._viewer=e,i._mainFilter=new SF.SmartFilter(e,a),i._mainFilter.tempId=0}static setChainSkip(t){i._chainSkip=t}static setShowLimitOption(t){i._showLimitOption=t}static async display(){await SF.SmartFilter.initialize(i._viewer);let t="";t+='<div class = "modelTreeSearchMain" id="'+i._maindiv+'_main">',i._showLimitOption?t+='<div style="position:relative;height:20px;"><label style="position:relative;">Limit:</label><input onclick=\'SFUI.SmartFilterEditor._limitSelection()\' style="position:relative;left:2px;top:2px;" type = "checkbox" id="'+i._maindiv+'_searchfromselection"></div>':t+='<div style="position:relative;height:20px;"></div>',t+='<button class="smartFilterSearchButton" type="button" style="right:65px;top:2px;position:absolute;" onclick=\'SFUI.SmartFilterEditor.selectAll(this)\'>Select All</button>',t+='<button class="smartFilterSearchButton" type="button" style="right:5px;top:2px;position:absolute;" onclick=\'SFUI.SmartFilterEditor.search()\'>Search</button>',t+='<hr style="margin-bottom:0px;margin-top:3px" >',t+='<div id="'+i._maindiv+'_conditions">',t+=await i._generateConditions(),t+="</div><hr>",t+='<div id="'+i._maindiv+'_searchitems" class="smartFilterSearchItems"></div>',t+='<div style="position:absolute; right:20px;bottom:0px; font-size:12px;background-color:white" id="'+i._maindiv+'_found">Found:</div>',t+="</div>",$("#"+i._maindiv).empty(),$("#"+i._maindiv).append(t),i._generateSearchResults(),i._addFilterFromUI(!1,0)}static getFilter(){return i._mainFilter}static adjust(){let t=$("#"+i._maindiv).parent().height()-($("#"+i._maindiv+"_searchitems").offset().top-$("#"+i._maindiv).parent().offset().top);$("#"+i._maindiv+"_searchitems").css({height:t+"px"});let e=$("#"+i._maindiv).offset().top-$("#"+i._maindiv).parent().offset().top;$("#"+i._maindiv+"_found").css({bottom:e+"px"})}static flush(){$("#"+i._maindiv).empty()}static async search(){i.updateFilterFromUI();let t=await i._mainFilter.apply(),e=i._mainFilter.getStartNode();i._founditems=[];for(let a=0;a<t.length;a++){let r=i._mainFilter.createChainText(t[a],e,i._chainSkip),l={name:i._viewer.model.getNodeName(t[a]),id:t[a],chaintext:r};i._founditems.push(l)}i._generateSearchResults()}static getSmartFilterFromTempId(t){if(0==t)return i._mainFilter;for(let e=0;e<i._mainFilter.getNumConditions();e++){let a=i._mainFilter.getCondition(e);if(a.childFilter&&a.childFilter.tempId==t)return a.childFilter}}static isolateAll(){let t=[];for(let e=0;e<i._founditems.length;e++)t.push(parseInt(i._founditems[e].id));i._viewer.view.isolateNodes(t)}static selectAll(){i.ctrlPressed||i._viewer.selectionManager.clear();let t=[];for(let e=0;e<i._founditems.length;e++)t.push(new Communicator.Selection.SelectionItem(parseInt(i._founditems[e].id)));i._viewer.selectionManager.add(t),i._generateSearchResults()}static updateFilterFromUI(t){let e;e=t||i._mainFilter;for(let t=0;t<e.getNumConditions();t++){let a=e.getCondition(t);a.childFilter?this.updateFilterFromUI(a.childFilter):(a.conditionType=SF.SmartFilter.convertStringConditionToEnum($("#"+i._maindiv+"_propertyChoiceSelect"+t+"-"+e.tempId)[0].value),null!=$("#"+i._maindiv+"_modeltreesearchtext"+t+"-"+e.tempId)[0]&&(a.text=i._htmlEncode($("#"+i._maindiv+"_modeltreesearchtext"+t+"-"+e.tempId)[0].value)),a.propertyName=$("#"+i._maindiv+"_propertyTypeSelect"+t+"-"+e.tempId)[0].value,a.propertyType=SF.SmartFilter.convertStringPropertyTypeToEnum(a.propertyName),1==t?a.and="and"==$("#"+i._maindiv+"_andOrchoiceSelect"+t+"-"+e.tempId)[0].value:t>1&&(a.and="and"==$("#"+i._maindiv+"_andOrchoiceSelect1-"+e.tempId)[0].value))}}static async refreshUI(){$("#"+i._maindiv+"_conditions").empty(),$("#"+i._maindiv+"_conditions").append(await i._generateConditions()),i.adjust()}static async _andorchangedFromUI(){i.updateFilterFromUI(),await i.refreshUI()}static async _addFilterFromUI(t,e){let a;i._clearSearchResults(),i.updateFilterFromUI(),a=i.getSmartFilterFromTempId(e);let r=null;if(t&&(r=new SF.SmartFilter(i._viewer,i._mainFilter.getStartNode()),r.addCondition(new SF.SmartFilterCondition)),a.getNumConditions()<=1){let t=new SF.SmartFilterCondition;t.setChildFilter(r),a.addCondition(t)}else{let t=a.getCondition(a.getNumConditions()-1),e=new SF.SmartFilterCondition;e.setChildFilter(r),e.setAndOr(t.getAndOr()),a.addCondition(e)}await i.refreshUI()}static _select(t){i.ctrlPressed?i._viewer.selectionManager.selectNode(parseInt(t),Communicator.SelectionMode.Toggle):i._viewer.selectionManager.selectNode(parseInt(t),Communicator.SelectionMode.Set),i._generateSearchResults()}static _deleteFilter(t,e){i._clearSearchResults(),i.updateFilterFromUI(),i.getSmartFilterFromTempId(e).removeCondition(t),i.refreshUI()}static _limitSelection(){if($("#"+i._maindiv+"_searchfromselection")[0].checked){let t=[],e=i._viewer.selectionManager.getResults();for(let i=0;i<e.length;i++)t.push(e[i].getNodeId());i._mainFilter.limitToNodes(t)}else i._mainFilter.limitToNodes([])}static _clearSearchResults(){i._founditems=void 0,i._generateSearchResults()}static _generateSearchResults(){if($("#"+i._maindiv+"_searchitems").empty(),$("#"+i._maindiv+"_found").empty(),null==i._founditems)return;$("#"+i._maindiv+"_found").append("Found:"+i._founditems.length);let t="",e=!0;for(let a=0;a<i._founditems.length;a++)e=!e,i._viewer.selectionManager.isSelected(Communicator.Selection.SelectionItem.create(i._founditems[a].id))?t+="<div onclick='SFUI.SmartFilterEditor._select(\""+i._founditems[a].id+'")\' class="smartFilterSearchItemselected">':t+=e?"<div onclick='SFUI.SmartFilterEditor._select(\""+i._founditems[a].id+'")\' class="modelTreeSearchItem1">':"<div onclick='SFUI.SmartFilterEditor._select(\""+i._founditems[a].id+'")\' class="modelTreeSearchItem2">',t+='<div class="smartFilterSearchItemText">'+i._htmlEncode(i._founditems[a].name)+"</div>",t+='<div class="smartFilterSearchItemChainText">'+i._htmlEncode(i._founditems[a].chaintext)+"</div>",t+="</div>";$("#"+i._maindiv+"_searchitems").append(t),i.adjust()}static _generateAndOrChoiceSelect(t,e,a){if(0==e||e>1)return 0==e?'<span style="top:7px;left:6px;position:relative;font-size:14px; margin-top:2px;width:50px;width:50px;max-width:50px;min-width:50px">Where:</span>':'<span style="top:7px;left:6px;position:relative;font-size:14px; margin-top:2px;width:50px;max-width:50px;min-width:50px">'+(t.and?"and":"or")+"</span>";{let r='<span style="top:7px;left:6px;position:relative;font-size:14px; margin-top:2px;width:50px;max-width:50px;min-width:50px">';return r+='<select class="smartFilterSearchSelect" onchange=\'SFUI.SmartFilterEditor._andorchangedFromUI()\' id="'+i._maindiv+"_andOrchoiceSelect"+e+"-"+a.tempId+'" value="">\n',t.and?(r+='<option value="and" selected>and</option>\n',r+='<option value="or">or</option>\n'):(r+='<option value="and">and</option>\n',r+='<option value="or" selected>or</option>\n'),r+="</select></span>\n",r}}static _generateChoiceSelect(t,e,a){let r='<select onchange=\'SFUI.SmartFilterEditor._andorchangedFromUI()\' style="width:60px;margin-right:3px;" id="'+i._maindiv+"_propertyChoiceSelect"+e+"-"+a.tempId+'" value="">\n',l=["has","exists","!exists",">=","<=","=","â‰ "];for(let e=0;e<l.length;e++)l[e]==SF.SmartFilter.convertEnumConditionToString(t.conditionType)?r+='<option selected value="'+l[e]+'">'+l[e]+"</option>\n":r+='<option value="'+l[e]+'">'+l[e]+"</option>\n";return r+="</select>\n",r}static _clearInputField(t,e){$("#"+i._maindiv+"_modeltreesearchtext"+t+"-"+e)[0]&&($("#"+i._maindiv+"_modeltreesearchtext"+t+"-"+e)[0].value="")}static _generatePropertyTypeSelect(t,e,a){let r="<select onchange='SFUI.SmartFilterEditor._clearInputField("+e+","+a.tempId+');SFUI.SmartFilterEditor._andorchangedFromUI();\' class="propertyTypeSelect" id="'+i._maindiv+"_propertyTypeSelect"+e+"-"+a.tempId+'" value="">\n',l=i._mainFilter.getAllProperties();l.unshift("Rel:SpaceBoundary"),l.unshift("Rel:ContainedIn"),l.unshift("Node Color"),l.unshift("Node Type"),l.unshift("Node Chain"),l.unshift("Nodeid"),l.unshift("Node Name");for(let e=0;e<l.length;e++)t.propertyName==l[e]?r+='<option value="'+l[e]+'" selected>'+l[e]+"</option>\n":r+='<option value="'+l[e]+'">'+l[e]+"</option>\n";return r+="</select>\n",r}static async _generateInput(t,e,a){let r='<input list="datalist'+e+"-"+a.tempId+'" +  style="flex:1 1 auto; font-size:11px;min-width:100px" id="'+i._maindiv+"_modeltreesearchtext"+e+"-"+a.tempId+'" value="'+t.text+'">\n';r+='<datalist id="datalist'+e+"-"+a.tempId+'">\n';let l=[];if("Node Type"==t.propertyName)for(const t in Communicator.NodeType)isNaN(parseFloat(Communicator.NodeType[t]))&&l.push(Communicator.NodeType[t]);else if("Node Color"==t.propertyName){if(i._viewer.selectionManager.getLast()){let t=i._viewer.selectionManager.getLast().getNodeId(),e=i._viewer.model.getNodeChildren(t);e.length>0&&(t=e[0]);let a=await i._viewer.model.getNodesEffectiveFaceColor([t]);l.push(a[0].r+" "+a[0].g+" "+a[0].b)}}else{let e=i._mainFilter.getAllOptionsForProperty(t.propertyName);for(let t in e)l.push(t)}l.sort();for(let e=0;e<l.length;e++)t.propertyName==l[e]?r+='<option value="'+l[e]+'" selected>'+l[e]+"</option>\n":r+='<option value="'+l[e]+'">'+l[e]+"</option>\n";return r+="</datalist>\n",r}static async _generateConditions(t,e){let a,r="";t?a=t:(i.tempId=0,a=i._mainFilter),a.tempId=i.tempId,t&&(r+=1==e?'<div style = "position:relative;left:65px;top:-10px;background:#e6e8ea;border-radius:5px;">':'<div style = "position:relative;left:50px;background:#e6e8ea;border-radius:5px;">');for(let t=0;t<a.getNumConditions();t++){let e=a.getCondition(t);e.childFilter?(i.tempId++,r+="<div>",r+='<div style="position:relative;width:10px; height:10px;float:left;top:10px;left:-1px" onclick=\'SFUI.SmartFilterEditor._deleteFilter('+t+","+a.tempId+")'>",r+='<div class="cross"></div></div>',r+=i._generateAndOrChoiceSelect(e,t,a),r+=await this._generateConditions(e.childFilter,t),r+="</div>"):(r+='<div style="height:30px;margin-top:-3px">',r+='<div style="position:relative;width:10px; height:10px;float:left;top:10px;left:-1px" onclick=\'SFUI.SmartFilterEditor._deleteFilter('+t+","+a.tempId+")'>",r+='<div class="cross"></div></div>',r+=i._generateAndOrChoiceSelect(e,t,a),r+=1==t?'<div style="display:flex;position:relative;top:-11px;left:64px;margin-right: 1em;">':'<div style="display:flex;position:relative;top:-10px;left:64px;margin-right: 1em;">',r+=i._generatePropertyTypeSelect(e,t,a),r+=i._generateChoiceSelect(e,t,a),"exists"!=SF.SmartFilter.convertEnumConditionToString(e.conditionType)&&"!exists"!=SF.SmartFilter.convertEnumConditionToString(e.conditionType)?r+=await i._generateInput(e,t,a):r+='<div style="position:relative;left:5px;top:0px;width:275px"></div>',r+="</div>",r+="</div>")}return r+='<button class="smartFilterSearchButton" type="button" style="margin-top:2px;left:2px;bottom:2px;position:relative;" onclick=\'SFUI.SmartFilterEditor._addFilterFromUI(false,'+a.tempId+")'>Add Condition</button>",r+=t?"</div>":'<button class="smartFilterSearchButton" type="button" style="left:4px;bottom:2px;position:relative;" onclick=\'SFUI.SmartFilterEditor._addFilterFromUI(true,'+a.tempId+")'>Add SubFilter</button>",r}}class a{static _updatedCallback=null;static initialize(t,e,i){a._table=null,a._viewer=t,a._uidiv=e,SF.SmartFilterManager.initialize(t),$("#"+a._uidiv).append('<button class="smartFilterSearchButton" id="smartFilterManagerAddCurrentFilter" type="button" style="left:0px;top:2px">Add</button>'),i&&($("#"+a._uidiv).append('<button class="smartFilterSearchButton" id="smartFilterManagerExport" type="button" style="position:absolute;right:0px;top:4px">Export</button>'),$("#"+a._uidiv).append('<button class="smartFilterSearchButton" id="smartFilterManagerUpload" type="button" style="position:absolute;right:58px;top:4px">Load</button><input style="display:none" type="file" id="inputupload">'),$("#smartFilterManagerExport").click((function(){a.exportToFile("smartfilters.json")})),$("#smartFilterManagerUpload").click((function(t){t.preventDefault(),$("#inputupload").trigger("click")})),$("#inputupload").change((function(){let t=$("#inputupload")[0].files;t.length>0&&a.load(t[0])}))),$("#smartFilterManagerAddCurrentFilter").click((function(){a._addCurrentFilter()})),$("#"+this._uidiv).append('<div id="'+a._uidiv+'Tabulator" style="overflow: hidden; zoom:0.7;width:100%; height:100%;"></div>'),a.refreshUI()}static setUpdatedCallback(t){a._updatedCallback=t}static async load(t){let e=new FileReader;e.onload=async function(t){let e=JSON.parse(t.target.result);SF.SmartFilterManager.fromJSON(e),a.refreshUI()},e.readAsText(t)}static async _addCurrentFilter(){i.updateFilterFromUI();let t=i.getFilter(),e=t.toJSON(),r=new SF.SmartFilter(a._viewer);r.fromJSON(e),r.setName(""),SF.SmartFilterManager.addSmartFilter(r,!1);let l=t.generateString(),n={};n.id=SF.SmartFilterManager.getSmartFilterNum()-1,n.description=l,await a._table.addRow(n),a._updatedCallback&&a._updatedCallback()}static _renderButtonCell(t){let e="",i=(t.getValue(),t.getRow().getData());e+='<div style="height:20px">',e+='<button class="smartFilterManagerButtons" id="sfm-select-'+t.getData().id+'" type="button" title="Press Shift to Isolate" ><span style="font-size:12px;top:-2px;position:relative;">Select</span></button>',e+='<button class="smartFilterManagerButtons" id="sfm-update-'+t.getData().id+'" type="button" ><span style="font-size:12px;top:-2px;position:relative;">Update</span></button>',e+='<button class="smartFilterManagerButtons" id="sfm-delete-'+t.getData().id+'" type="button" ><span style="font-size:12px;top:-2px;position:relative;">Del</span></button>',e+="</div>",$(t.getElement()).append(e),$("#sfm-select-"+t.getData().id).on("click",(function(t){t.stopPropagation(),a._handleTableSelection(i,t.shiftKey)})),$("#sfm-update-"+t.getData().id).on("click",(function(e){e.stopPropagation(),a._handleSmartFilterUpdate(t.getRow())})),$("#sfm-delete-"+t.getData().id).on("click",(function(e){e.stopPropagation(),SF.SmartFilterManager.removeSmartFilter(i.id),t.getRow().delete()}))}static async refreshUI(){a._table?await a._table.clearData():(a._table=new Tabulator("#"+a._uidiv+"Tabulator",{data:[],selectable:0,layout:"fitColumns",columns:[{title:"Description",field:"description",formatter:"textarea",editor:"textarea"},{title:"",width:160,field:"buttons",formatter:function(t,e,i){i((function(){a._renderButtonCell(t)}))}},{title:"ID",field:"id",width:20,visible:!1},{title:"Prop",field:"prop",width:70,hozAlign:"center",formatter:"tickCross",sorter:"boolean",editor:!0,editorParams:{tristate:!1}}]}),a._table.on("cellEdited",(function(t){"description"==t.getField()?a._handleSmartFilterNameEdit(t.getRow()):a._handleSmartFilterIsPropEdit(t.getRow())})));for(let t=0;t<SF.SmartFilterManager.getSmartFilterNum();t++){let e,i=SF.SmartFilterManager.getSmartFilter(t);e=""==i.getName()?i.generateString():i.getName();let r={};r.id=t,r.description=e,r.prop=SF.SmartFilterManager.getIsProp(t),await a._table.addRow(r)}}static async _handleTableSelection(t,e){let a=SF.SmartFilterManager.getSmartFilter(t.id).toJSON();i.getFilter().fromJSON(a),await i.refreshUI(),await i.search(),e?await i.isolateAll():await i.selectAll()}static async _handleSmartFilterNameEdit(t){let e=t.getData(),i=SF.SmartFilterManager.getSmartFilter(e.id);i.setName(e.description),""==e.description&&t.update({description:i.generateString()}),a._updatedCallback&&a._updatedCallback()}static async _handleSmartFilterIsPropEdit(t){let e=t.getData();SF.SmartFilterManager.updateSmartFilterIsProp(e.id,e.prop),a._updatedCallback&&a._updatedCallback()}static _handleSmartFilterUpdate(t){let e=t.getData(),r=SF.SmartFilterManager.getSmartFilter(e.id);i.updateFilterFromUI();let l=i.getFilter().toJSON(),n=new SF.SmartFilter(a._viewer);n.fromJSON(l),n.setName(r.getName()),SF.SmartFilterManager.updateSmartFilter(e.id,n),""==n.getName()&&t.update({description:n.generateString()}),a._updatedCallback&&a._updatedCallback()}static exportToFile(t){let e=JSON.stringify(SF.SmartFilterManager.toJSON()),i=document.createElement("a");i.setAttribute("download",t),i.href=function(t){let e=new Blob([t],{type:"text/plain"});return window.URL.createObjectURL(e)}(e),document.body.appendChild(i),window.requestAnimationFrame((function(){let t=new MouseEvent("click");i.dispatchEvent(t),document.body.removeChild(i)}))}}class r{static initialize(t,e){r._table=null,r._viewer=t,r._uidiv=e,t.setCallbacks({selectionArray:function(t,e){r._itemSelected()}}),$("#"+this._uidiv).append('<div id="'+r._uidiv+'Tabulator" style="overflow: hidden; zoom:0.7;width:100%; height:100%;"></div>'),r._refreshUI()}static async _refreshUI(){r._table?await r._table.clearData():r._table=new Tabulator("#"+r._uidiv+"Tabulator",{data:[],dataTree:!0,dataTreeStartExpanded:!1,selectable:1,layout:"fitColumns",columns:[{title:"Name",field:"name"},{title:"Value",field:"value"},{title:"ID",field:"id",width:20,visible:!1}]})}static async _itemSelected(){let t=r._viewer.selectionManager.getResults();if(await r._table.clearData(),t.length>0){let e=t[0].getNodeId(),i=await SF.SmartFilterManager.evaluateProperties(e),a=0;for(let t=0;t<i.length;t++){let e=i[t].properties;if(0==e.length){let e={};e.id=a++,e.name=i[t].name,e.value="true",await r._table.addRow(e)}else if(1==e.length){let l={};l.id=a++,l.name=i[t].name,l.value=e[0].name+":"+e[0].value,await r._table.addRow(l)}else{let l={};l.id=a++,l.name=i[t].name;let n=[];for(let t=0;t<e.length;t++){let i={};i.id=a++,i.name=e[t].name,i.value=e[t].value,n.push(i)}l._children=n,await r._table.addRow(l)}}}}}function l(){return"1.0.2"}SFUI=e})();