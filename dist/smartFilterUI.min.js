var SFUI;(()=>{"use strict";var e={d:(t,i)=>{for(var a in i)e.o(i,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:i[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{SmartFilterEditor:()=>i,SmartFilterManagerUI:()=>a,SmartPropertiesUI:()=>r,getVersion:()=>l});class i{static _htmlEncode(e){return(e=$.trim(e)).replace(/[&"'\<\>]/g,(function(e){switch(e){case"&":return"&amp;";case"'":return"&#39;";case'"':return"&quot;";case"<":return"&lt;";default:return"&gt;"}}))}static initialize(e,t,a){i.ctrlPressed=!1,$(document).on("keyup keydown",(function(e){i.ctrlPressed=e.ctrlKey})),i._maindiv=e,i._viewer=t,i._mtSearch=new SF.SmartFilter(t,a),i._mtSearch.tempId=0}static async display(){await SF.SmartFilter.initialize(i._viewer);let e="";e+='<div class = "modelTreeSearchMain" id="'+i._maindiv+'_main">',e+='<label style="position:relative;left:5px;">Limit:</label><input onclick=\'SFUI.SmartFilterEditor._limitSelection()\' style="position:relative;left:2px;top:2px;" type = "checkbox" id="'+i._maindiv+'_searchfromselection">',e+='<button class="modelTreeSearchButton" type="button" style="right:65px;top:2px;position:absolute;" onclick=\'SFUI.SmartFilterEditor.selectAll(this)\'>Select All</button>',e+='<button class="modelTreeSearchButton" type="button" style="right:5px;top:2px;position:absolute;" onclick=\'SFUI.SmartFilterEditor.search()\'>Search</button>',e+="<hr>",e+='<div id="'+i._maindiv+'_filters">',e+=await i._generateFilters(),e+="</div><hr>",e+='<div id="'+i._maindiv+'_searchitems" class="modelTreeSearchItems"></div>',e+='<div style="position:absolute; right:3px;bottom:20px; font-size:12px;background-color:white" id="'+i._maindiv+'_found">Found:</div>',e+="</div>",$("#"+i._maindiv).empty(),$("#"+i._maindiv).append(e),i._generateSearchResults(),i._addFilterFromUI(!1,0)}static getFilter(){return i._mtSearch}static refresh(){let e=$("#"+i._maindiv+"_main").height()-$("#"+i._maindiv+"_filters").height()-40;$("#"+i._maindiv+"_searchitems").css({height:e+"px"})}static flush(){$("#"+i._maindiv).empty()}static async _andorchangedFromUI(){i.getFiltersFromUI(),await i.updateFilters()}static async search(){i.getFiltersFromUI();let e=await i._mtSearch.apply(),t=i._mtSearch.getStartNode();i._founditems=[];for(let a=0;a<e.length;a++){let r=i._mtSearch.createChainText(e[a],t),l={name:i._viewer.model.getNodeName(e[a]),id:e[a],chaintext:r};i._founditems.push(l)}i._generateSearchResults()}static getSmartFilterFromTempId(e){if(0==e)return i._mtSearch;for(let t=0;t<i._mtSearch.getNumConditions();t++){let a=i._mtSearch.getCondition(t);if(a.childFilter&&a.childFilter.tempId==e)return a.childFilter}}static async _addFilterFromUI(e,t){let a;i._clearSearchResults(),i.getFiltersFromUI(),a=i.getSmartFilterFromTempId(t);let r=null;if(e&&(r=new SF.SmartFilter(i._viewer,i._mtSearch.getStartNode()),r.addCondition(new SF.SmartFilterCondition)),a.getNumConditions()<=1){let e=new SF.SmartFilterCondition;e.setChildFilter(r),a.addCondition(e)}else{let e=a.getCondition(a.getNumConditions()-1),t=new SF.SmartFilterCondition;t.setChildFilter(r),t.setAndOr(e.getAndOr()),a.addCondition(t)}await i.updateFilters()}static isolateAll(){let e=[];for(let t=0;t<i._founditems.length;t++)e.push(parseInt(i._founditems[t].id));i._viewer.view.isolateNodes(e)}static selectAll(){i.ctrlPressed||i._viewer.selectionManager.clear();let e=[];for(let t=0;t<i._founditems.length;t++)e.push(new Communicator.Selection.SelectionItem(parseInt(i._founditems[t].id)));i._viewer.selectionManager.add(e),i._generateSearchResults()}static _select(e){i.ctrlPressed?i._viewer.selectionManager.selectNode(parseInt(e),Communicator.SelectionMode.Toggle):i._viewer.selectionManager.selectNode(parseInt(e),Communicator.SelectionMode.Set),i._generateSearchResults()}static _deleteFilter(e,t){i._clearSearchResults(),i.getFiltersFromUI(),i.getSmartFilterFromTempId(t).removeCondition(e),i.updateFilters()}static _limitSelection(){if($("#"+i._maindiv+"_searchfromselection")[0].checked){let e=[],t=i._viewer.selectionManager.getResults();for(let i=0;i<t.length;i++)e.push(t[i].getNodeId());i._mtSearch.limitToNodes(e)}else i._mtSearch.limitToNodes([])}static _clearSearchResults(){i._founditems=void 0,i._generateSearchResults()}static _generateSearchResults(){if($("#"+i._maindiv+"_searchitems").empty(),$("#"+i._maindiv+"_found").empty(),null==i._founditems)return;$("#"+i._maindiv+"_found").append("Found:"+i._founditems.length);let e="",t=!0;for(let a=0;a<i._founditems.length;a++)t=!t,i._viewer.selectionManager.isSelected(Communicator.Selection.SelectionItem.create(i._founditems[a].id))?e+="<div onclick='SFUI.SmartFilterEditor._select(\""+i._founditems[a].id+'")\' class="modelTreeSearchItemSelected">':e+=t?"<div onclick='SFUI.SmartFilterEditor._select(\""+i._founditems[a].id+'")\' class="modelTreeSearchItem1">':"<div onclick='SFUI.SmartFilterEditor._select(\""+i._founditems[a].id+'")\' class="modelTreeSearchItem2">',e+='<div class="modelTreeSearchItemText">'+i._htmlEncode(i._founditems[a].name)+"</div>",e+='<div class="modelTreeSearchItemChainText">'+i._htmlEncode(i._founditems[a].chaintext)+"</div>",e+="</div>";$("#"+i._maindiv+"_searchitems").append(e),i.refresh()}static _generateAndOrChoiceSelect(e,t,a){if(0==t||t>1)return 0==t?'<span style="top:7px;left:6px;position:relative;font-size:14px; margin-top:2px;width:50px;width:50px;max-width:50px;min-width:50px">Where:</span>':'<span style="top:7px;left:6px;position:relative;font-size:14px; margin-top:2px;width:50px;max-width:50px;min-width:50px">'+(e.and?"and":"or")+"</span>";{let r='<span style="top:7px;left:6px;position:relative;font-size:14px; margin-top:2px;width:50px;max-width:50px;min-width:50px">';return r+="<select onchange='SFUI.SmartFilterEditor._andorchangedFromUI()' id=\""+i._maindiv+"_andOrchoiceSelect"+t+"-"+a.tempId+'" value="">\n',e.and?(r+='<option value="and" selected>and</option>\n',r+='<option value="or">or</option>\n'):(r+='<option value="and">and</option>\n',r+='<option value="or" selected>or</option>\n'),r+="</select></span>\n",r}}static _generateChoiceSelect(e,t,a){let r='<select onchange=\'SFUI.SmartFilterEditor._andorchangedFromUI()\' style="width:60px;margin-right:3px;" id="'+i._maindiv+"_propertyChoiceSelect"+t+"-"+a.tempId+'" value="">\n',l=["has","exists","!exists",">=","<=","=","â‰ "];for(let t=0;t<l.length;t++)l[t]==SF.SmartFilter.convertEnumConditionToString(e.conditionType)?r+='<option selected value="'+l[t]+'">'+l[t]+"</option>\n":r+='<option value="'+l[t]+'">'+l[t]+"</option>\n";return r+="</select>\n",r}static _clearInputField(e,t){$("#"+i._maindiv+"_modeltreesearchtext"+e+"-"+t)[0]&&($("#"+i._maindiv+"_modeltreesearchtext"+e+"-"+t)[0].value="")}static _generatePropertyTypeSelect(e,t,a){let r="<select onchange='SFUI.SmartFilterEditor._clearInputField("+t+","+a.tempId+');SFUI.SmartFilterEditor._andorchangedFromUI();\' style="font-size:11px; flex: 1 1 auto;max-width:150px;margin-right:3px;min-width:50px" id="'+i._maindiv+"_propertyTypeSelect"+t+"-"+a.tempId+'" value="">\n',l=i._mtSearch.getAllProperties();l.unshift("Rel:SpaceBoundary"),l.unshift("Rel:ContainedIn"),l.unshift("Node Color"),l.unshift("Node Type"),l.unshift("Node Chain"),l.unshift("Nodeid"),l.unshift("Node Name");for(let t=0;t<l.length;t++)e.propertyName==l[t]?r+='<option value="'+l[t]+'" selected>'+l[t]+"</option>\n":r+='<option value="'+l[t]+'">'+l[t]+"</option>\n";return r+="</select>\n",r}static async _generateInput(e,t,a){let r='<input list="datalist'+t+"-"+a.tempId+'" +  style="flex:1 1 auto; font-size:11px;min-width:100px" id="'+i._maindiv+"_modeltreesearchtext"+t+"-"+a.tempId+'" value="'+e.text+'">\n';r+='<datalist id="datalist'+t+"-"+a.tempId+'">\n';let l=[];if("Node Type"==e.propertyName)for(const e in Communicator.NodeType)isNaN(parseFloat(Communicator.NodeType[e]))&&l.push(Communicator.NodeType[e]);else if("Node Color"==e.propertyName){if(i._viewer.selectionManager.getLast()){let e=i._viewer.selectionManager.getLast().getNodeId(),t=i._viewer.model.getNodeChildren(e);t.length>0&&(e=t[0]);let a=await i._viewer.model.getNodesEffectiveFaceColor([e]);l.push(a[0].r+" "+a[0].g+" "+a[0].b)}}else{let t=i._mtSearch.getAllOptionsForProperty(e.propertyName);for(let e in t)l.push(e)}l.sort();for(let t=0;t<l.length;t++)e.propertyName==l[t]?r+='<option value="'+l[t]+'" selected>'+l[t]+"</option>\n":r+='<option value="'+l[t]+'">'+l[t]+"</option>\n";return r+="</datalist>\n",r}static async _generateFilters(e,t){let a,r="";e?a=e:(i.tempId=0,a=i._mtSearch),a.tempId=i.tempId,e&&(r+=1==t?'<div style = "position:relative;left:65px;top:-10px;background:#e6e8ea;border-radius:5px;">':'<div style = "position:relative;left:50px;background:#e6e8ea;border-radius:5px;">');for(let e=0;e<a.getNumConditions();e++){let t=a.getCondition(e);t.childFilter?(i.tempId++,r+="<div>",r+='<div style="position:relative;width:10px; height:10px;float:left;top:10px;left:-1px" onclick=\'SFUI.SmartFilterEditor._deleteFilter('+e+","+a.tempId+")'>",r+='<div class="cross"></div></div>',r+=i._generateAndOrChoiceSelect(t,e,a),r+=await this._generateFilters(t.childFilter,e),r+="</div>"):(r+='<div style="height:30px">',r+='<div style="position:relative;width:10px; height:10px;float:left;top:10px;left:-1px" onclick=\'SFUI.SmartFilterEditor._deleteFilter('+e+","+a.tempId+")'>",r+='<div class="cross"></div></div>',r+=i._generateAndOrChoiceSelect(t,e,a),r+=1==e?'<div style="display:flex;position:relative;top:-11px;left:64px;margin-right: 1em;">':'<div style="display:flex;position:relative;top:-10px;left:64px;margin-right: 1em;">',r+=i._generatePropertyTypeSelect(t,e,a),r+=i._generateChoiceSelect(t,e,a),"exists"!=SF.SmartFilter.convertEnumConditionToString(t.conditionType)&&"!exists"!=SF.SmartFilter.convertEnumConditionToString(t.conditionType)?r+=await i._generateInput(t,e,a):r+='<div style="position:relative;left:5px;top:0px;width:275px"></div>',r+="</div>",r+="</div>")}return r+='<button class="modelTreeSearchButton" type="button" style="margin-top:2px;left:2px;bottom:2px;position:relative;" onclick=\'SFUI.SmartFilterEditor._addFilterFromUI(false,'+a.tempId+")'>Add Condition</button>",r+=e?"</div>":'<button class="modelTreeSearchButton" type="button" style="left:4px;bottom:2px;position:relative;" onclick=\'SFUI.SmartFilterEditor._addFilterFromUI(true,'+a.tempId+")'>Add SubFilter</button>",r}static getFiltersFromUI(e){let t;t=e||i._mtSearch;for(let e=0;e<t.getNumConditions();e++){let a=t.getCondition(e);if(a.childFilter)this.getFiltersFromUI(a.childFilter);else{switch(a.conditionType=SF.SmartFilter.convertStringConditionToEnum($("#"+i._maindiv+"_propertyChoiceSelect"+e+"-"+t.tempId)[0].value),null!=$("#"+i._maindiv+"_modeltreesearchtext"+e+"-"+t.tempId)[0]&&(a.text=i._htmlEncode($("#"+i._maindiv+"_modeltreesearchtext"+e+"-"+t.tempId)[0].value)),a.propertyName=$("#"+i._maindiv+"_propertyTypeSelect"+e+"-"+t.tempId)[0].value,a.propertyName){case"Node Name":a.propertyType=SF.SmartFilterPropertyType.nodeName;break;case"Nodeid":a.propertyType=SF.SmartFilterPropertyType.nodeId;break;case"Node Chain":a.propertyType=SF.SmartFilterPropertyType.nodeChain;break;case"Node Type":a.propertyType=SF.SmartFilterPropertyType.nodeType;break;case"Node Color":a.propertyType=SF.SmartFilterPropertyType.nodeColor;break;case"Rel:ContainedIn":case"Rel:SpaceBoundary":a.propertyType=SF.SmartFilterPropertyType.relationship;break;default:a.propertyType=SF.SmartFilterPropertyType.property}1==e?a.and="and"==$("#"+i._maindiv+"_andOrchoiceSelect"+e+"-"+t.tempId)[0].value:e>1&&(a.and="and"==$("#"+i._maindiv+"_andOrchoiceSelect1-"+t.tempId)[0].value)}}}static async updateFilters(){$("#"+i._maindiv+"_filters").empty(),$("#"+i._maindiv+"_filters").append(await i._generateFilters()),i.refresh()}}class a{static initialize(e,t){a._table=null,a._viewer=e,a._uidiv=t,SF.SmartFilterManager.initialize(e),$("#"+a._uidiv).append('<button id="smartFilterManagerAddCurrentFilter" type="button" style="left:0px;top:2px">Add</button>'),$("#"+a._uidiv).append('<button id="smartFilterManagerExport" type="button" style="position:absolute;right:0px;top:0px">Export</button>'),$("#"+a._uidiv).append('<button id="smartFilterManagerUpload" type="button" style="position:absolute;right:58px;top:0px">Load</button><input style="display:none" type="file" id="inputupload">'),$("#smartFilterManagerAddCurrentFilter").click((function(){a._addCurrentFilter()})),$("#smartFilterManagerExport").click((function(){a.exportToFile("smartfilters.json")})),$("#smartFilterManagerUpload").click((function(e){e.preventDefault(),$("#inputupload").trigger("click")})),$("#inputupload").change((function(){let e=$("#inputupload")[0].files;e.length>0&&a.load(e[0])})),$("#"+this._uidiv).append('<div id="'+a._uidiv+'Tabulator" style="overflow: hidden; zoom:0.7;width:100%; height:100%;"></div>'),a._refreshUI()}static async load(e){let t=new FileReader;t.onload=async function(e){let t=JSON.parse(e.target.result);SF.SmartFilterManager.fromJSON(t),a._refreshUI()},t.readAsText(e)}static async _addCurrentFilter(){i.getFiltersFromUI();let e=i.getFilter(),t=e.toJSON(),r=new SF.SmartFilter(a._viewer);r.fromJSON(t),r.setName(""),SF.SmartFilterManager.addSmartFilter(r,!1);let l=e.generateString(),o={};o.id=SF.SmartFilterManager.getSmartFilterNum()-1,o.description=l,await a._table.addRow(o)}static _renderButtonCell(e){let t="",i=(e.getValue(),e.getRow().getData());t+='<div style="height:20px">',t+='<button id="sfm-select-'+e.getData().id+'" type="button" title="Press Shift to Isolate" style="position:relative;top:2px;height:18px"><span style="font-size:12px;top:-2px;position:relative;">Select</span></button>',t+='<button id="sfm-update-'+e.getData().id+'" type="button" style="margin-left:2px; position:relative;top:2px;height:18px"><span style="font-size:12px;top:-2px;position:relative;">Update</span></button>',t+='<button id="sfm-delete-'+e.getData().id+'" type="button" style="margin-left:2px; position:relative;top:2px;height:18px"><span style="font-size:12px;top:-2px;position:relative;">Del</span></button>',t+="</div>",$(e.getElement()).append(t),$("#sfm-select-"+e.getData().id).on("click",(function(e){e.stopPropagation(),a._handleTableSelection(i,e.shiftKey)})),$("#sfm-update-"+e.getData().id).on("click",(function(t){t.stopPropagation(),a._handleSmartFilterUpdate(e.getRow())})),$("#sfm-delete-"+e.getData().id).on("click",(function(t){t.stopPropagation(),SF.SmartFilterManager.removeSmartFilter(i.id),e.getRow().delete()}))}static async _refreshUI(){a._table?await a._table.clearData():(a._table=new Tabulator("#"+a._uidiv+"Tabulator",{data:[],selectable:0,layout:"fitColumns",columns:[{title:"Description",field:"description",formatter:"textarea",editor:"textarea"},{title:"",width:160,field:"buttons",formatter:function(e,t,i){i((function(){a._renderButtonCell(e)}))}},{title:"ID",field:"id",width:20,visible:!1},{title:"Prop",field:"prop",width:70,hozAlign:"center",formatter:"tickCross",sorter:"boolean",editor:!0,editorParams:{tristate:!1}}]}),a._table.on("cellEdited",(function(e){"description"==e.getField()?a._handleSmartFilterNameEdit(e.getRow()):a._handleSmartFilterIsPropEdit(e.getRow())})));for(let e=0;e<SF.SmartFilterManager.getSmartFilterNum();e++){let t,i=SF.SmartFilterManager.getSmartFilter(e);t=""==i.getName()?i.generateString():i.getName();let r={};r.id=e,r.description=t,r.prop=SF.SmartFilterManager.getIsProp(e),await a._table.addRow(r)}}static async _handleTableSelection(e,t){let a=SF.SmartFilterManager.getSmartFilter(e.id).toJSON();i.getFilter().fromJSON(a),await i.updateFilters(),await i.search(),t?await i.isolateAll():await i.selectAll()}static async _handleSmartFilterNameEdit(e){let t=e.getData(),i=SF.SmartFilterManager.getSmartFilter(t.id);i.setName(t.description),""==t.description&&e.update({description:i.generateString()})}static async _handleSmartFilterIsPropEdit(e){let t=e.getData();SF.SmartFilterManager.updateSmartFilterIsProp(t.id,t.prop)}static _handleSmartFilterUpdate(e){let t=e.getData(),r=SF.SmartFilterManager.getSmartFilter(t.id);i.getFiltersFromUI();let l=i.getFilter().toJSON(),o=new SF.SmartFilter(a._viewer);o.fromJSON(l),o.setName(r.getName()),SF.SmartFilterManager.updateSmartFilter(t.id,o),""==o.getName()&&e.update({description:o.generateString()})}static exportToFile(e){let t=JSON.stringify(SF.SmartFilterManager.toJSON()),i=document.createElement("a");i.setAttribute("download",e),i.href=function(e){let t=new Blob([e],{type:"text/plain"});return window.URL.createObjectURL(t)}(t),document.body.appendChild(i),window.requestAnimationFrame((function(){let e=new MouseEvent("click");i.dispatchEvent(e),document.body.removeChild(i)}))}}class r{static initialize(e,t){r._table=null,r._viewer=e,r._uidiv=t,e.setCallbacks({selectionArray:function(e,t){r._itemSelected()}}),$("#"+this._uidiv).append('<div id="'+r._uidiv+'Tabulator" style="overflow: hidden; zoom:0.7;width:100%; height:100%;"></div>'),r._refreshUI()}static async _refreshUI(){r._table?await r._table.clearData():r._table=new Tabulator("#"+r._uidiv+"Tabulator",{data:[],dataTree:!0,dataTreeStartExpanded:!1,selectable:1,layout:"fitColumns",columns:[{title:"Name",field:"name"},{title:"Value",field:"value"},{title:"ID",field:"id",width:20,visible:!1}]})}static async _itemSelected(){let e=r._viewer.selectionManager.getResults();if(await r._table.clearData(),e.length>0){let t=e[0].getNodeId(),i=await SF.SmartFilterManager.evaluateProperties(t),a=0;for(let e=0;e<i.length;e++){let t=i[e].properties;if(0==t.length){let t={};t.id=a++,t.name=i[e].name,t.value="true",await r._table.addRow(t)}else if(1==t.length){let l={};l.id=a++,l.name=i[e].name,l.value=t[0].name+":"+t[0].value,await r._table.addRow(l)}else{let l={};l.id=a++,l.name=i[e].name;let o=[];for(let e=0;e<t.length;e++){let i={};i.id=a++,i.name=t[e].name,i.value=t[e].value,o.push(i)}l._children=o,await r._table.addRow(l)}}}}}function l(){return"1.0.0"}SFUI=t})();