var SFUI;(()=>{"use strict";var e={d:(t,i)=>{for(var r in i)e.o(i,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:i[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{SmartFilterEditor:()=>i,SmartFilterManagerUI:()=>r,SmartPropertiesUI:()=>a});class i{static _htmlEncode(e){return(e=$.trim(e)).replace(/[&"'\<\>]/g,(function(e){switch(e){case"&":return"&amp;";case"'":return"&#39;";case'"':return"&quot;";case"<":return"&lt;";default:return"&gt;"}}))}static initialize(e,t,r){i.ctrlPressed=!1,$(document).on("keyup keydown",(function(e){i.ctrlPressed=e.ctrlKey})),i.filterHash=[],i._mtSearch=new SF.SmartFilter(t,r),i._mtSearch.tempId=0,i.filterHash[0]=i._mtSearch,i._maindiv=e,i._viewer=t,i._mtSearch=new SF.SmartFilter(t,r)}static async display(){await SF.SmartFilter.initialize(i._viewer);let e="";e+='<div class = "modelTreeSearchMain" id="'+i._maindiv+'_main">',e+='<label style="position:relative;left:5px;">Limit:</label><input onclick=\'SmartFilterEditor._limitSelection()\' style="position:relative;left:2px;top:2px;" type = "checkbox" id="'+i._maindiv+'_searchfromselection">',e+='<button class="modelTreeSearchButton" type="button" style="right:65px;top:2px;position:absolute;" onclick=\'SmartFilterEditor.selectAll(this)\'>Select All</button>',e+='<button class="modelTreeSearchButton" type="button" style="right:5px;top:2px;position:absolute;" onclick=\'SmartFilterEditor.search()\'>Search</button>',e+="<hr>",e+='<div id="'+i._maindiv+'_filters">',e+=await i._generateFilters(),e+="</div><hr>",e+='<div id="'+i._maindiv+'_searchitems" class="modelTreeSearchItems"></div>',e+='<div style="position:absolute; right:3px;bottom:20px; font-size:12px;background-color:white" id="'+i._maindiv+'_found">Found:</div>',e+="</div>",$("#"+i._maindiv).empty(),$("#"+i._maindiv).append(e),i._generateSearchResults(),i._addFilterFromUI(!1,0)}static getFilter(){return i._mtSearch}static refresh(){let e=$("#"+i._maindiv+"_main").height()-$("#"+i._maindiv+"_filters").height()-40;$("#"+i._maindiv+"_searchitems").css({height:e+"px"})}static flush(){$("#"+i._maindiv).empty()}static async _andorchangedFromUI(){i.getFiltersFromUI(),await i.updateFilters()}static async search(){i.getFiltersFromUI();let e=await i._mtSearch.apply(),t=i._mtSearch.getStartNode();i._founditems=[];for(let r=0;r<e.length;r++){let a=i._mtSearch.createChainText(e[r],t),l={name:i._viewer.model.getNodeName(e[r]),id:e[r],chaintext:a};i._founditems.push(l)}i._generateSearchResults()}static getSmartFilterFromTempId(e){if(0==e)return i._mtSearch;for(let t=0;t<i._mtSearch.getNumConditions();t++){let r=i._mtSearch.getCondition(t);if(r.childFilter&&r.childFilter.tempId==e)return r.childFilter}}static async _addFilterFromUI(e,t){let r;i._clearSearchResults(),i.getFiltersFromUI(),r=i.getSmartFilterFromTempId(t);let a=null;if(e&&(a=new SF.SmartFilter(i._viewer,i._mtSearch.getStartNode()),a.addCondition({and:!0,propertyType:SF.SmartFilterPropertyType.nodeName,propertyName:"",choice:"has",text:"",childFilter:null})),r.getNumConditions()<=1)r.addCondition({and:!0,propertyType:SF.SmartFilterPropertyType.nodeName,propertyName:"",choice:"has",text:"",childFilter:a});else{let e=r.getCondition(r.getNumConditions()-1);r.addCondition({and:e.and,propertyType:SF.SmartFilterPropertyType.nodeName,propertyName:"",choice:"has",text:"",childFilter:a})}await i.updateFilters()}static isolateAll(){let e=[];for(let t=0;t<i._founditems.length;t++)e.push(parseInt(i._founditems[t].id));i._viewer.view.isolateNodes(e)}static selectAll(){i.ctrlPressed||i._viewer.selectionManager.clear();let e=[];for(let t=0;t<i._founditems.length;t++)e.push(new Communicator.Selection.SelectionItem(parseInt(i._founditems[t].id)));i._viewer.selectionManager.add(e),i._generateSearchResults()}static _select(e){i.ctrlPressed?i._viewer.selectionManager.selectNode(parseInt(e),Communicator.SelectionMode.Toggle):i._viewer.selectionManager.selectNode(parseInt(e),Communicator.SelectionMode.Set),i._generateSearchResults()}static _deleteFilter(e,t){i._clearSearchResults(),i.getFiltersFromUI(),i.getSmartFilterFromTempId(t).removeCondition(e),i.updateFilters()}static _limitSelection(){if($("#"+i._maindiv+"_searchfromselection")[0].checked){let e=[],t=i._viewer.selectionManager.getResults();for(let i=0;i<t.length;i++)e.push(t[i].getNodeId());i._mtSearch.limitToNodes(e)}else i._mtSearch.limitToNodes([])}static _clearSearchResults(){i._founditems=void 0,i._generateSearchResults()}static _generateSearchResults(){if($("#"+i._maindiv+"_searchitems").empty(),$("#"+i._maindiv+"_found").empty(),null==i._founditems)return;$("#"+i._maindiv+"_found").append("Found:"+i._founditems.length);let e="",t=!0;for(let r=0;r<i._founditems.length;r++)t=!t,i._viewer.selectionManager.isSelected(Communicator.Selection.SelectionItem.create(i._founditems[r].id))?e+="<div onclick='SmartFilterEditor._select(\""+i._founditems[r].id+'")\' class="modelTreeSearchItemSelected">':e+=t?"<div onclick='SmartFilterEditor._select(\""+i._founditems[r].id+'")\' class="modelTreeSearchItem1">':"<div onclick='SmartFilterEditor._select(\""+i._founditems[r].id+'")\' class="modelTreeSearchItem2">',e+='<div class="modelTreeSearchItemText">'+i._htmlEncode(i._founditems[r].name)+"</div>",e+='<div class="modelTreeSearchItemChainText">'+i._htmlEncode(i._founditems[r].chaintext)+"</div>",e+="</div>";$("#"+i._maindiv+"_searchitems").append(e),i.refresh()}static _generateAndOrChoiceSelect(e,t,r){if(0==t||t>1)return 0==t?'<span style="top:7px;left:6px;position:relative;font-size:14px; margin-top:2px;width:50px;width:50px;max-width:50px;min-width:50px">Where:</span>':'<span style="top:7px;left:6px;position:relative;font-size:14px; margin-top:2px;width:50px;max-width:50px;min-width:50px">'+(e.and?"and":"or")+"</span>";{let a='<span style="top:7px;left:6px;position:relative;font-size:14px; margin-top:2px;width:50px;max-width:50px;min-width:50px">';return a+="<select onchange='SmartFilterEditor._andorchangedFromUI()' id=\""+i._maindiv+"_andOrchoiceSelect"+t+"-"+r.tempId+'" value="">\n',e.and?(a+='<option value="and" selected>and</option>\n',a+='<option value="or">or</option>\n'):(a+='<option value="and">and</option>\n',a+='<option value="or" selected>or</option>\n'),a+="</select></span>\n",a}}static _generateChoiceSelect(e,t,r){let a='<select onchange=\'SmartFilterEditor._andorchangedFromUI()\' style="width:60px;margin-right:3px;" id="'+i._maindiv+"_propertyChoiceSelect"+t+"-"+r.tempId+'" value="">\n',l=["has","exists","!exists",">=","<=","=","â‰ "];for(let t=0;t<l.length;t++)l[t]==SF.SmartFilter.convertEnumConditionToString(e.conditionType)?a+='<option selected value="'+l[t]+'">'+l[t]+"</option>\n":a+='<option value="'+l[t]+'">'+l[t]+"</option>\n";return a+="</select>\n",a}static _clearInputField(e,t){$("#"+i._maindiv+"_modeltreesearchtext"+e+"-"+t)[0]&&($("#"+i._maindiv+"_modeltreesearchtext"+e+"-"+t)[0].value="")}static _generatePropertyTypeSelect(e,t,r){let a="<select onchange='SmartFilterEditor._clearInputField("+t+","+r.tempId+');SmartFilterEditor._andorchangedFromUI();\' style="font-size:11px; flex: 1 1 auto;max-width:150px;margin-right:3px;min-width:50px" id="'+i._maindiv+"_propertyTypeSelect"+t+"-"+r.tempId+'" value="">\n',l=i._mtSearch.getAllProperties();l.unshift("Rel:SpaceBoundary"),l.unshift("Rel:ContainedIn"),l.unshift("Node Color"),l.unshift("Node Type"),l.unshift("Node Chain"),l.unshift("Nodeid"),l.unshift("Node Name");for(let t=0;t<l.length;t++)e.propertyName==l[t]?a+='<option value="'+l[t]+'" selected>'+l[t]+"</option>\n":a+='<option value="'+l[t]+'">'+l[t]+"</option>\n";return a+="</select>\n",a}static async _generateInput(e,t,r){let a='<input list="datalist'+t+"-"+r.tempId+'" +  style="flex:1 1 auto; font-size:11px;min-width:100px" id="'+i._maindiv+"_modeltreesearchtext"+t+"-"+r.tempId+'" value="'+e.text+'">\n';a+='<datalist id="datalist'+t+"-"+r.tempId+'">\n';let l=[];if("Node Type"==e.propertyName)for(const e in Communicator.NodeType)isNaN(parseFloat(Communicator.NodeType[e]))&&l.push(Communicator.NodeType[e]);else if("Node Color"==e.propertyName){if(i._viewer.selectionManager.getLast()){let e=i._viewer.selectionManager.getLast().getNodeId(),t=i._viewer.model.getNodeChildren(e);t.length>0&&(e=t[0]);let r=await i._viewer.model.getNodesEffectiveFaceColor([e]);l.push(r[0].r+" "+r[0].g+" "+r[0].b)}}else{let t=i._mtSearch.getAllOptionsForProperty(e.propertyName);for(let e in t)l.push(e)}l.sort();for(let t=0;t<l.length;t++)e.propertyName==l[t]?a+='<option value="'+l[t]+'" selected>'+l[t]+"</option>\n":a+='<option value="'+l[t]+'">'+l[t]+"</option>\n";return a+="</datalist>\n",a}static async _generateFilters(e,t){let r,a="";e?r=e:(i.tempId=0,r=i._mtSearch),r.tempId=i.tempId,e&&(a+=1==t?'<div style = "position:relative;left:65px;top:-10px;background:#e6e8ea;border-radius:5px;">':'<div style = "position:relative;left:50px;background:#e6e8ea;border-radius:5px;">');for(let e=0;e<r.getNumConditions();e++){let t=r.getCondition(e);t.childFilter?(i.tempId++,a+="<div>",a+='<div style="position:relative;width:10px; height:10px;float:left;top:10px;left:-1px" onclick=\'SmartFilterEditor._deleteFilter('+e+","+r.tempId+")'>",a+='<div class="cross"></div></div>',a+=i._generateAndOrChoiceSelect(t,e,r),a+=await this._generateFilters(t.childFilter,e),a+="</div>"):(a+='<div style="height:30px">',a+='<div style="position:relative;width:10px; height:10px;float:left;top:10px;left:-1px" onclick=\'SmartFilterEditor._deleteFilter('+e+","+r.tempId+")'>",a+='<div class="cross"></div></div>',a+=i._generateAndOrChoiceSelect(t,e,r),a+=1==e?'<div style="display:flex;position:relative;top:-11px;left:64px;margin-right: 1em;">':'<div style="display:flex;position:relative;top:-10px;left:64px;margin-right: 1em;">',a+=i._generatePropertyTypeSelect(t,e,r),a+=i._generateChoiceSelect(t,e,r),"exists"!=SF.SmartFilter.convertEnumConditionToString(t.conditionType)&&"!exists"!=SF.SmartFilter.convertEnumConditionToString(t.conditionType)?a+=await i._generateInput(t,e,r):a+='<div style="position:relative;left:5px;top:0px;width:275px"></div>',a+="</div>",a+="</div>")}return a+='<button class="modelTreeSearchButton" type="button" style="margin-top:2px;left:2px;bottom:2px;position:relative;" onclick=\'SmartFilterEditor._addFilterFromUI(false,'+r.tempId+")'>Add Condition</button>",a+=e?"</div>":'<button class="modelTreeSearchButton" type="button" style="left:4px;bottom:2px;position:relative;" onclick=\'SmartFilterEditor._addFilterFromUI(true,'+r.tempId+")'>Add SubFilter</button>",a}static getFiltersFromUI(e){let t;t=e||i._mtSearch;for(let e=0;e<t.getNumConditions();e++){let r=t.getCondition(e);if(r.childFilter)this.getFiltersFromUI(r.childFilter);else{switch(r.conditionType=SF.SmartFilter.convertStringConditionToEnum($("#"+i._maindiv+"_propertyChoiceSelect"+e+"-"+t.tempId)[0].value),null!=$("#"+i._maindiv+"_modeltreesearchtext"+e+"-"+t.tempId)[0]&&(r.text=i._htmlEncode($("#"+i._maindiv+"_modeltreesearchtext"+e+"-"+t.tempId)[0].value)),r.propertyName=$("#"+i._maindiv+"_propertyTypeSelect"+e+"-"+t.tempId)[0].value,r.propertyName){case"Node Name":r.propertyType=SF.SmartFilterPropertyType.nodeName;break;case"Nodeid":r.propertyType=SF.SmartFilterPropertyType.nodeId;break;case"Node Chain":r.propertyType=SF.SmartFilterPropertyType.nodeChain;break;case"Node Type":r.propertyType=SF.SmartFilterPropertyType.nodeType;break;case"Node Color":r.propertyType=SF.SmartFilterPropertyType.nodeColor;break;case"Rel:ContainedIn":case"Rel:SpaceBoundary":r.propertyType=SF.SmartFilterPropertyType.relationship;break;default:r.propertyType=SF.SmartFilterPropertyType.property}1==e?r.and="and"==$("#"+i._maindiv+"_andOrchoiceSelect"+e+"-"+t.tempId)[0].value:e>1&&(r.and="and"==$("#"+i._maindiv+"_andOrchoiceSelect1-"+t.tempId)[0].value)}}}static async updateFilters(){$("#"+i._maindiv+"_filters").empty(),$("#"+i._maindiv+"_filters").append(await i._generateFilters()),i.refresh()}}class r{static initialize(e,t){r._table=null,r._viewer=e,r._uidiv=t,SF.SmartFilterManager.initialize(e),$("#"+r._uidiv).append('<button id="smartFilterManagerAddCurrentFilter" type="button" style="left:0px;top:2px">Add</button>'),$("#"+r._uidiv).append('<button id="smartFilterManagerExport" type="button" style="position:absolute;right:0px;top:0px">Export</button>'),$("#"+r._uidiv).append('<button id="smartFilterManagerUpload" type="button" style="position:absolute;right:58px;top:0px">Load</button><input style="display:none" type="file" id="inputupload">'),$("#smartFilterManagerAddCurrentFilter").click((function(){r._addCurrentFilter()})),$("#smartFilterManagerExport").click((function(){r.exportToFile("smartfilters.json")})),$("#smartFilterManagerUpload").click((function(e){e.preventDefault(),$("#inputupload").trigger("click")})),$("#inputupload").change((function(){let e=$("#inputupload")[0].files;e.length>0&&r.load(e[0])})),$("#"+this._uidiv).append('<div id="'+r._uidiv+'Tabulator" style="overflow: hidden; zoom:0.7;width:100%; height:100%;"></div>'),r._refreshUI()}static async load(e){let t=new FileReader;t.onload=async function(e){let t=JSON.parse(e.target.result);SF.SmartFilterManager.fromJSON(t),r._refreshUI()},t.readAsText(e)}static async _addCurrentFilter(){SmartFilterEditor.getFiltersFromUI();let e=SmartFilterEditor.getFilter(),t=e.toJSON(),i=new SF.SmartFilter(r._viewer);i.fromJSON(t),i.setName(""),SF.SmartFilterManager.addSmartFilter(i,!1);let a=e.generateString(),l={};l.id=SF.SmartFilterManager.getSmartFilterNum()-1,l.description=a,await r._table.addRow(l)}static _renderButtonCell(e){let t="",i=(e.getValue(),e.getRow().getData());t+='<div style="height:20px">',t+='<button id="sfm-select-'+e.getData().id+'" type="button" title="Press Shift to Isolate" style="position:relative;top:2px;height:18px"><span style="font-size:12px;top:-2px;position:relative;">Select</span></button>',t+='<button id="sfm-update-'+e.getData().id+'" type="button" style="margin-left:2px; position:relative;top:2px;height:18px"><span style="font-size:12px;top:-2px;position:relative;">Update</span></button>',t+='<button id="sfm-delete-'+e.getData().id+'" type="button" style="margin-left:2px; position:relative;top:2px;height:18px"><span style="font-size:12px;top:-2px;position:relative;">Del</span></button>',t+="</div>",$(e.getElement()).append(t),$("#sfm-select-"+e.getData().id).on("click",(function(e){e.stopPropagation(),r._handleTableSelection(i,e.shiftKey)})),$("#sfm-update-"+e.getData().id).on("click",(function(t){t.stopPropagation(),r._handleSmartFilterUpdate(e.getRow())})),$("#sfm-delete-"+e.getData().id).on("click",(function(t){t.stopPropagation(),SF.SmartFilterManager.removeSmartFilter(i.id),e.getRow().delete()}))}static async _refreshUI(){r._table?await r._table.clearData():(r._table=new Tabulator("#"+r._uidiv+"Tabulator",{data:[],selectable:0,layout:"fitColumns",columns:[{title:"Description",field:"description",formatter:"textarea",editor:"textarea"},{title:"",width:160,field:"buttons",formatter:function(e,t,i){i((function(){r._renderButtonCell(e)}))}},{title:"ID",field:"id",width:20,visible:!1},{title:"Prop",field:"prop",width:70,hozAlign:"center",formatter:"tickCross",sorter:"boolean",editor:!0,editorParams:{tristate:!1}}]}),r._table.on("cellEdited",(function(e){"description"==e.getField()?r._handleSmartFilterNameEdit(e.getRow()):r._handleSmartFilterIsPropEdit(e.getRow())})));for(let e=0;e<SF.SmartFilterManager.getSmartFilterNum();e++){let t,i=SF.SmartFilterManager.getSmartFilter(e);t=""==i.getName()?i.generateString():i.getName();let a={};a.id=e,a.description=t,a.prop=SF.SmartFilterManager.getIsProp(e),await r._table.addRow(a)}}static async _handleTableSelection(e,t){let i=SF.SmartFilterManager.getSmartFilter(e.id).toJSON();SmartFilterEditor.getFilter().fromJSON(i),await SmartFilterEditor.updateFilters(),await SmartFilterEditor.search(),t?await SmartFilterEditor.isolateAll():await SmartFilterEditor.selectAll()}static async _handleSmartFilterNameEdit(e){let t=e.getData(),i=SF.SmartFilterManager.getSmartFilter(t.id);i.setName(t.description),""==t.description&&e.update({description:i.generateString()})}static async _handleSmartFilterIsPropEdit(e){let t=e.getData();SF.SmartFilterManager.updateSmartFilterIsProp(t.id,t.prop)}static _handleSmartFilterUpdate(e){let t=e.getData(),i=SF.SmartFilterManager.getSmartFilter(t.id);SmartFilterEditor.getFiltersFromUI();let a=SmartFilterEditor.getFilter().toJSON(),l=new SF.SmartFilter(r._viewer);l.fromJSON(a),l.setName(i.getName()),SF.SmartFilterManager.updateSmartFilter(t.id,l),""==l.getName()&&e.update({description:l.generateString()})}static exportToFile(e){let t=JSON.stringify(SF.SmartFilterManager.toJSON()),i=document.createElement("a");i.setAttribute("download",e),i.href=function(e){let t=new Blob([e],{type:"text/plain"});return window.URL.createObjectURL(t)}(t),document.body.appendChild(i),window.requestAnimationFrame((function(){let e=new MouseEvent("click");i.dispatchEvent(e),document.body.removeChild(i)}))}}class a{static initialize(e,t){a._table=null,a._viewer=e,a._uidiv=t,e.setCallbacks({selectionArray:function(e,t){a._itemSelected()}}),$("#"+this._uidiv).append('<div id="'+a._uidiv+'Tabulator" style="overflow: hidden; zoom:0.7;width:100%; height:100%;"></div>'),a._refreshUI()}static async _refreshUI(){a._table?await a._table.clearData():a._table=new Tabulator("#"+a._uidiv+"Tabulator",{data:[],dataTree:!0,dataTreeStartExpanded:!1,selectable:1,layout:"fitColumns",columns:[{title:"Name",field:"name"},{title:"Value",field:"value"},{title:"ID",field:"id",width:20,visible:!1}]})}static async _itemSelected(){let e=a._viewer.selectionManager.getResults();if(await a._table.clearData(),e.length>0){let t=e[0].getNodeId(),i=await SF.SmartFilterManager.evaluateProperties(t),r=0;for(let e=0;e<i.length;e++){let t=i[e].properties;if(0==t.length){let t={};t.id=r++,t.name=i[e].name,t.value="true",await a._table.addRow(t)}else if(1==t.length){let l={};l.id=r++,l.name=i[e].name,l.value=t[0].name+":"+t[0].value,await a._table.addRow(l)}else{let l={};l.id=r++,l.name=i[e].name;let o=[];for(let e=0;e<t.length;e++){let i={};i.id=r++,i.name=t[e].name,i.value=t[e].value,o.push(i)}l._children=o,await a._table.addRow(l)}}}}}SFUI=t})();