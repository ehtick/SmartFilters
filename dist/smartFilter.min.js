var hcSmartFilter;(()=>{"use strict";var e={d:(t,i)=>{for(var r in i)e.o(i,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:i[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{SmartFilter:()=>n,SmartFilterCondition:()=>i,SmartFilterConditionType:()=>s,SmartFilterManager:()=>r,SmartFilterPropertyType:()=>o,getVersion:()=>a});class i{constructor(){this.and=!0,this.conditionType=s.contains,this.propertyType=o.nodeName,this.propertyName="",this.text="",this.childFilter=null,this.smartFilterID=null}toJSON(){return{and:this.and,conditionType:this.conditionType,propertyType:this.propertyType,propertyName:JSON.parse(JSON.stringify(this.propertyName)),text:this.text,childFilter:this.childFilter,smartFilterID:this.smartFilterID}}fromJSON(e){this.and=e.and,this.conditionType=e.conditionType,this.propertyType=e.propertyType,this.propertyName=e.propertyName,this.text=e.text,this.childFilter=e.childFilter,this.smartFilterID=e.smartFilterID}setSmartFilterID(e){this.smartFitlerID=e}getSmartFilterID(){return this.smartFilterID}setAndOr(e){this.and=e}getAndOr(){return this.and}setConditionType(e){this.conditionType=e}getConditionType(){return this.conditionType}setPropertyName(e){this.propertyName=e}getPropertyName(){return this.propertyName}setPropertyType(e){this.propertyType=e}getPropertyType(){return this.propertyType}setText(e){this.text=e}getText(){return this.text}setChildFilter(e){this.childFilter=e}getChildFilter(){return this.childFilter}}class r{static _smartFilters=[];static initialize(e){r._viewer=e,r._smartFilters=[]}static addSmartFilter(e,t){r._smartFilters.push({filter:e,isProp:t})}static getSmartFilters(){return r._smartFilters}static getSmartFilterByName(e){for(let t=0;t<r._smartFilters.length;t++)if(r._smartFilters[t].filter.getName()==e)return r._smartFilters[t]}static getSmartFilterByID(e){for(let t=0;t<r._smartFilters.length;t++)if(r._smartFilters[t].filter._id==e)return r._smartFilters[t].filter}static getSmartFilterNum(){return r._smartFilters.length}static getSmartFilter(e){return r._smartFilters[e].filter}static getSmartFilterID(e){return r._smartFilters[e].filter._id}static getIsProp(e){return r._smartFilters[e].isProp}static removeSmartFilter(e){return r._smartFilters.splice(e,1)}static updateSmartFilter(e,t){r._smartFilters[e].filter=t}static updateSmartFilterIsProp(e,t){for(let i=0;i<r._smartFilters.length;i++)r._smartFilters[i].filter._id==e&&(r._smartFilters[i].isProp=t)}static toJSON(){let e=[];for(let t=0;t<r._smartFilters.length;t++)e.push({filter:r._smartFilters[t].filter.toJSON(),isProp:r._smartFilters[t].isProp});return e}static fromJSON(e){r._smartFilters=[];for(let t=0;t<e.length;t++){let i=new n(r._viewer);i.fromJSON(e[t].filter),r.addSmartFilter(i,e[t].isProp)}return e}static async evaluateProperties(e){let t=[];for(let i=0;i<r._smartFilters.length;i++)if(r._smartFilters[i].isProp){let s=r._smartFilters[i].filter;if(await s.testOneNodeAgainstConditions(e)){let i=await s.findAllPropertiesOnNode(e),r=s.getName();""==r&&(r=s.generateString()),t.push({name:r,properties:i})}}return t}}const s={contains:0,exists:1,notExists:2,greaterOrEqual:3,lessOrEqual:4,equals:5,unequal:6},o={nodeName:0,nodeId:1,nodeChain:2,nodeType:3,nodeColor:4,relationship:5,property:6,smartFilter:7};class n{static _propertyHash=[];static _allPropertiesHash=[];static _containedInSpatialStructureHash=[];static _spaceBoundaryHash=[];static _modelHash=[];static convertEnumConditionToString(e){switch(e){case s.contains:return"contains";case s.exists:return"exists";case s.notExists:return"!exists";case s.greaterOrEqual:return">=";case s.lessOrEqual:return"<=";case s.equals:return"=";case s.unequal:return"≠"}}static convertStringConditionToEnum(e){switch(e){case"contains":return s.contains;case"exists":return s.exists;case"!exists":return s.notExists;case">=":return s.greaterOrEqual;case"<=":return s.lessOrEqual;case"=":return s.equals;case"≠":return s.unequal}}static convertStringPropertyTypeToEnum(e){if(e.indexOf("SmartFilter")>-1)return o.smartFilter;switch(e){case"Node Name":return o.nodeName;case"Nodeid":return o.nodeId;case"Node Chain":return o.nodeChain;case"Node Type":return o.nodeType;case"Node Color":return o.nodeColor;case"Rel:ContainedIn":case"Rel:SpaceBoundary":return o.relationship;case"Smart Filter":return o.smartFilter;default:return o.property}}static _getModelTreeIdsRecursive(e,t,i,r){t.push(r.model.getNodeProperties(e)),i.push(e);let s=r.model.getNodeChildren(e);for(let e=0;e<s.length;e++)n._getModelTreeIdsRecursive(s[e],t,i,r)}static addModel(e,t){for(let i=0;i<n._modelHash.length;i++)if(n._modelHash[i].id==e)return void(n._modelHash[i].nodeid=t);n._modelHash.push({id:e,nodeid:t,ids:null,properties:null})}static _updateHashes(e,t,i,r){for(let s=0;s<i.length;s++){n._propertyHash[t[s]]=i[s];let o=e.model.getNodeLayerId(t[s]);null!=o&&r.size>1&&(null==n._propertyHash[t[s]]&&(n._propertyHash[t[s]]=[]),n._propertyHash[t[s]].LAYER=r.get(o));for(let e in i[s])n._allPropertiesHash[e]=[]}for(let e in n._propertyHash)for(let t in n._propertyHash[e])n._allPropertiesHash[t][n._propertyHash[e][t]]=!0}static async initialize(e){n._propertyHash=[],n._allPropertiesHash=[],n._containedInSpatialStructureHash=[],n._spaceBoundaryHash=[];let t=e.model.getLayers();if(0==n._modelHash.length){let i=[],r=[];n._getModelTreeIdsRecursive(e.model.getRootNode(),i,r,e);let s=await Promise.all(i);n._updateHashes(e,r,s,t)}else for(let i=0;i<n._modelHash.length;i++){let r=n._modelHash[i],s=[],o=null,a=e.model.getNodeIdOffset(r.nodeid);if(r.ids){for(let e=0;e<r.ids.length;e++)s.push(r.ids[e]+a);o=r.properties}else{let t=[];n._getModelTreeIdsRecursive(r.nodeid,t,s,e),o=await Promise.all(t),r.properties=o,r.ids=[];for(let e=0;e<s.length;e++)r.ids.push(s[e]-a)}n._updateHashes(e,s,o,t)}}constructor(e,t){this._viewer=e,this._limitselectionlist=[],this._conditions=[],this._name="",this._id=this._generateGUID(),this._startnode=t||this._viewer.model.getRootNode()}updateConditions(e){this._conditions=e}setName(e){this._name=e,""==this._name&&(this._name=this.generateString())}getName(){return this._name}getNumConditions(){return this._conditions.length}getCondition(e){return this._conditions[e]}addCondition(e){this._conditions.push(e)}removeCondition(e){if(this._conditions.splice(e,1),this._conditions[0].childFilter){let e=this._conditions[0].childFilter;this._conditions.splice(0,1);for(let t=0;t<e._conditions.length;t++)this._conditions.unshift(e._conditions[t])}}getAllProperties(){let e=[],t=!1;n._allPropertiesHash.TYPE&&(t=!0);for(let t in n._allPropertiesHash)"TYPE"!=t&&e.push(t);return e.sort(),t&&e.unshift("TYPE"),e.unshift("Smart Filter"),e.unshift("Rel:SpaceBoundary"),e.unshift("Rel:ContainedIn"),e.unshift("Node Color"),e.unshift("Node Type"),e.unshift("Node Chain"),e.unshift("Nodeid"),e.unshift("Node Name"),e}getAllOptionsForProperty(e){return n._allPropertiesHash[e]}fromJSON(e){this._conditions=[];for(let t=0;t<e.conditions.length;t++){let r=new i;r.fromJSON(e.conditions[t]),this._conditions.push(r)}for(let e=0;e<this._conditions.length;e++)if(this._conditions[e].childFilter){let t=new n(this._viewer,this._conditions[e].childFilter.startnode);t.fromJSON(this._conditions[e].childFilter),this._conditions[e].childFilter=t}this._name=e.name,e.id&&(this._id=e.id)}toJSON(){let e=[];for(let t=0;t<this._conditions.length;t++){let i=this._conditions[t].toJSON();this._conditions[t].childFilter&&(i.childFilter=this._conditions[t].childFilter.toJSON()),e.push(i)}return{conditions:e,name:this._name,id:this._id}}limitToNodes(e){this._limitselectionlist=[];for(let t=0;t<e.length;t++)this._limitselectionlist.push(e[t])}getStartNode(){return this._startnode}async apply(){let e=this._conditions,t=this._limitselectionlist;for(let t=0;t<e.length;t++)e[t].text=e[t].text.replace(/&quot;/g,'"');let i=[];if(0==t.length)this._startnode==this._viewer.model.getRootNode()?await this._gatherMatchingNodesRecursive(e,this._startnode,i,this._startnode):await this._gatherMatchingNodesRecursive(e,this._startnode,i,this._viewer.model.getNodeParent(this._startnode));else for(let r=0;r<t.length;r++)await this._gatherMatchingNodesRecursive(e,t[r],i,this._viewer.model.getNodeParent(t[r]));return i}createChainText(e,t,i){let r=e,s=[];for(s.push(this._viewer.model.getNodeName(e));;){let e=this._viewer.model.getNodeParent(r);if(null==e||e==t)break;s.push(this._viewer.model.getNodeName(e)),r=e}let o="";for(let e=s.length-1-i;e>=0;e--)o+=e>0?s[e]+"->":s[e];return o}async testOneNodeAgainstConditions(e){let t=this._conditions;for(let e=0;e<t.length;e++)t[e].text=t[e].text.replace(/&quot;/g,'"');return await this._testNodeAgainstConditions(e,this._conditions)}async findAllPropertiesOnNode(e,t,i,r){let s,a,l;t?(s=t,a=i,l=r):(s=this._conditions,a=[],l=[]);for(let t=0;t<s.length;t++)if(s[t].childFilter)await this.findAllPropertiesOnNode(e,s[t].childFilter._conditions,a,l);else if(s[t].propertyType==o.property){let i=n._propertyHash[e];i[s[t].propertyName]&&!l[s[t].propertyName]&&(l[s[t].propertyName]=!0,a.push({name:s[t].propertyName,value:i[s[t].propertyName]}))}return a}generateString(){let e="";for(let t=0;t<this._conditions.length;t++)t>0&&(e+=" "+(this._conditions[t].and?"and":"or")+" "),this._conditions[t].childFilter?e+="("+this._conditions[t].childFilter.generateString()+") ":e+=this._conditions[t].propertyName+" "+n.convertEnumConditionToString(this._conditions[t].conditionType)+" "+this._conditions[t].text;return e=e.replace(/&quot;/g,'"'),e}async _checkSpaceBoundaryFilter(e,t){let i,r=this._viewer.model.getBimIdFromNode(e);if(n._spaceBoundaryHash[e]?i=n._spaceBoundaryHash[e]:(i=this._viewer.model.getBimIdRelatingElements(e,r,Communicator.RelationshipType.SpaceBoundary),n._spaceBoundaryHash[e]=i),i.length>0){let r=this._viewer.model.getNodeIdOffset(e);for(let e=0;e<i.length;e++)if(await this._checkFilter(parseInt(i[e])+r,t))return!0}return!1}async _checkContainedInFilter(e,t){let i,r=this._viewer.model.getBimIdFromNode(e);if(n._containedInSpatialStructureHash[e]?i=n._containedInSpatialStructureHash[e]:(i=this._viewer.model.getBimIdRelatingElements(e,r,Communicator.RelationshipType.ContainedInSpatialStructure),n._containedInSpatialStructureHash[e]=i),i.length>0){let r=this._viewer.model.getNodeIdOffset(e);for(let e=0;e<i.length;e++)if(await this._checkFilter(parseInt(i[e])+r,t))return!0}return!1}async _checkFilter(e,t){if(t.conditionType!=s.contains){if(t.conditionType==s.exists)return!(!n._propertyHash[e]||null==n._propertyHash[e][t.propertyName]);if(t.conditionType==s.notExists)return!(!n._propertyHash[e]||null!=n._propertyHash[e][t.propertyName]);let i;if(t.propertyType==o.nodeName)i=parseFloat(this._viewer.model.getNodeName(e));else if(t.propertyType==o.nodeId)i=e;else{let r;if(n._propertyHash[e]&&(r=n._propertyHash[e][t.propertyName]),null==r)return t.conditionType==s.unequal;i=parseFloat(r)}let r=parseFloat(t.text);if(isNaN(r)||isNaN(i))return!1;if(t.conditionType==s.greaterOrEqual){if(i>=r)return!0}else if(t.conditionType==s.lessOrEqual){if(i<=r)return!0}else if(t.conditionType==s.unequal){if(i!=r)return!0}else if(i==r)return!0;return!1}{let i=t.text.split(","),r="";if(t.propertyType==o.nodeName||t.propertyType==o.relationship)r=this._viewer.model.getNodeName(e);else if(t.propertyType==o.nodeChain)r=this.createChainText(e,this._viewer.model.getRootNode(),0);else if(t.propertyType==o.nodeType)r=Communicator.NodeType[this._viewer.model.getNodeType(e)];else if(t.propertyType==o.nodeColor)if(this._viewer.model.getNodeChildren(e).length>0)r="x";else{let t=await this._viewer.model.getNodesEffectiveFaceColor([e]);r=t.length>0?t[0].r+" "+t[0].g+" "+t[0].b:"x"}else r=t.propertyType==o.nodeId?e.toString():null==n._propertyHash[e]||null==n._propertyHash[e][t.propertyName]?void 0:n._propertyHash[e][t.propertyName];null==r&&(r="");let s=0,a=0,l=0,d=0,h=0;for(let e=0;e<i.length;e++){let n,p;if('"'==i[e][0]||'"'==i[e][1])if(n=!0,'"'==i[e][0])p=i[e].substring(1,i[e].length-1);else{let t=i[e][0];p=i[e].substring(2,i[e].length-1),p=t+p}else p=i[e],n=!1;if(t.propertyType==o.nodeId&&(n=!0),""==p||1==p.length&&("+"==p[0]||"-"==p[0]))return;"+"==p[0]?(a++,n?r.toLowerCase()==p.substring(1).toLowerCase()&&s++:-1!=r.toLowerCase().indexOf(p.substring(1).toLowerCase())&&s++):"-"==p[0]?(l++,n?r.toLowerCase()!=p.substring(1).toLowerCase()&&d++:-1==r.toLowerCase().indexOf(p.substring(1).toLowerCase())&&d++):n?r.toLowerCase()==p.toLowerCase()&&h++:-1!=r.toLowerCase().indexOf(p.toLowerCase())&&h++}return a==s&&l==d&&(h>0||s+d==i.length)}}async _testNodeAgainstConditions(e,t){let i=0,s=!1;t.length>1&&!t[1].and&&(s=!0);for(let n=0;n<t.length;n++){let a;if(t[n].propertyType==o.relationship)"Rel:SpaceBoundary"==t[n].propertyName?a=await this._checkSpaceBoundaryFilter(e,t[n]):"Rel:ContainedIn"==t[n].propertyName&&(a=await this._checkContainedInFilter(e,t[n]));else if(t[n].propertyType==o.smartFilter){if(!t[n].smartFilter)if(t[n].smartFilterID)t[n].smartFilter=r.getSmartFilterByID(t[n].smartFilterID);else{let e=r.getSmartFilterByName(t[n].text);t[n].smartFilterID=e.id,t[n].smartFilter=e.filter}a=await this._testNodeAgainstConditions(e,t[n].smartFilter._conditions,s)}else a=t[n].childFilter?await this._testNodeAgainstConditions(e,t[n].childFilter._conditions,s):await this._checkFilter(e,t[n]);if(0==a){if(!s)break}else i++}return!!(!s&&i==t.length||s&&i>0)}async _gatherMatchingNodesRecursive(e,t,i,r){t!=r&&await this._testNodeAgainstConditions(t,e)&&i.push(t);let s=this._viewer.model.getNodeChildren(t);for(let t=0;t<s.length;t++)await this._gatherMatchingNodesRecursive(e,s[t],i,r)}_generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}}function a(){return"1.0.3"}hcSmartFilter=t})();