var SF;(()=>{"use strict";var e={d:(t,i)=>{for(var r in i)e.o(i,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:i[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{SmartFilter:()=>s,SmartFilterCondition:()=>o,SmartFilterConditionType:()=>i,SmartFilterManager:()=>n,SmartFilterPropertyType:()=>r});const i={has:0,exists:1,notExists:2,greaterOrEqual:3,lessOrEqual:4,equals:5,unequal:6},r={nodeName:0,nodeId:1,nodeChain:2,nodeType:3,nodeColor:4,relationship:5,property:6};class s{static _propertyHash=[];static _allPropertiesHash=[];static containedInSpatialStructureHash=[];static spaceBoundaryHash=[];static convertEnumConditionToString(e){switch(e){case i.has:return"has";case i.exists:return"exists";case i.notExists:return"!exists";case i.greaterOrEqual:return">=";case i.lessOrEqual:return"<=";case i.equals:return"=";case i.unequal:return"≠"}}static convertStringConditionToEnum(e){switch(e){case"has":return i.has;case"exists":return i.exists;case"!exists":return i.notExists;case">=":return i.greaterOrEqual;case"<=":return i.lessOrEqual;case"=":return i.equals;case"≠":return i.unequal}}static _getModelTreeIdsRecursive(e,t,i,r){t.push(r.model.getNodeProperties(e)),i.push(e);let o=r.model.getNodeChildren(e);for(let e=0;e<o.length;e++)s._getModelTreeIdsRecursive(o[e],t,i,r)}static initialize(e){let t=e.model.getLayers();return new Promise((function(i,r){let o=[],n=[];s._getModelTreeIdsRecursive(e.model.getRootNode(),o,n,e),Promise.all(o).then((function(r){for(let i=0;i<r.length;i++){s._propertyHash[n[i]]=r[i];let o=e.model.getNodeLayerId(n[i]);null!=o&&t.size>1&&(null==s._propertyHash[n[i]]&&(s._propertyHash[n[i]]=[]),s._propertyHash[n[i]].LAYER=t.get(o));for(let e in r[i])s._allPropertiesHash[e]=[]}for(let e in s._propertyHash)for(let t in s._propertyHash[e])s._allPropertiesHash[t][s._propertyHash[e][t]]=!0;i()}))}))}constructor(e,t){this._viewer=e,this._limitselectionlist=[],this._conditions=[],this._name="",this._startnode=t||this._viewer.model.getRootNode()}setName(e){this._name=e}getName(){return this._name}getNumConditions(){return this._conditions.length}getCondition(e){return this._conditions[e]}addCondition(e){this._conditions.push(e)}removeCondition(e){this._conditions.splice(e,1)}getAllProperties(){let e=[],t=!1;s._allPropertiesHash.TYPE&&(t=!0);for(let t in s._allPropertiesHash)"TYPE"!=t&&e.push(t);return e.sort(),t&&e.unshift("TYPE"),e}getAllOptionsForProperty(e){return s._allPropertiesHash[e]}fromJSON(e){this._conditions=e.conditions;for(let e=0;e<this._conditions.length;e++)if(this._conditions[e].childFilter){let t=new s(this._viewer,this._conditions[e].childFilter.startnode);t.fromJSON(this._conditions[e].childFilter),this._conditions[e].childFilter=t}this._name=e.name}toJSON(){let e=[];for(let t=0;t<this._conditions.length;t++){let i={and:this._conditions[t].and,propertyType:this._conditions[t].propertyType,propertyName:JSON.parse(JSON.stringify(this._conditions[t].propertyName)),conditionType:this._conditions[t].conditionType,text:JSON.parse(JSON.stringify(this._conditions[t].text))};this._conditions[t].childFilter&&(i.childFilter=this._conditions[t].childFilter.toJSON()),e.push(i)}return{conditions:e,name:this._name}}limitToNodes(e){this._limitselectionlist=[];for(let t=0;t<e.length;t++)this._limitselectionlist.push(e[t])}getStartNode(){return this._startnode}async apply(){let e=this._conditions,t=this._limitselectionlist;for(let t=0;t<e.length;t++)e[t].text=e[t].text.replace(/&quot;/g,'"');let i=[];if(0==t.length)this._startnode==hwv.model.getRootNode()?await this._gatherMatchingNodesRecursive(e,this._startnode,i,this._startnode):await this._gatherMatchingNodesRecursive(e,this._startnode,i,hwv.model.getNodeParent(this._startnode));else for(let r=0;r<t.length;r++)await this._gatherMatchingNodesRecursive(e,t[r],i,this._viewer.model.getNodeParent(t[r]));return i}createChainText(e,t){let i=e,r=[];for(r.push(this._viewer.model.getNodeName(e));;){let e=this._viewer.model.getNodeParent(i);if(null==e||e==t)break;r.push(this._viewer.model.getNodeName(e)),i=e}let s="";for(let e=r.length-1;e>=0;e--)s+=e>0?r[e]+"->":r[e];return s}async _checkSpaceBoundaryFilter(e,t){let i,r=this._viewer.model.getBimIdFromNode(e);if(s.spaceBoundaryHash[e]?i=s.spaceBoundaryHash[e]:(i=hwv.model.getBimIdRelatingElements(e,r,Communicator.RelationshipType.SpaceBoundary),s.spaceBoundaryHash[e]=i),i.length>0){let r=this._viewer.model.getNodeIdOffset(e);for(let e=0;e<i.length;e++)if(await this._checkFilter(parseInt(i[e])+r,t))return!0}return!1}async _checkContainedInFilter(e,t){let i,r=this._viewer.model.getBimIdFromNode(e);if(s.containedInSpatialStructureHash[e]?i=s.containedInSpatialStructureHash[e]:(i=hwv.model.getBimIdRelatingElements(e,r,Communicator.RelationshipType.ContainedInSpatialStructure),s.containedInSpatialStructureHash[e]=i),i.length>0){let r=this._viewer.model.getNodeIdOffset(e);for(let e=0;e<i.length;e++)if(await this._checkFilter(parseInt(i[e])+r,t))return!0}return!1}async _checkFilter(e,t){if(t.conditionType!=i.has){if(t.conditionType==i.exists)return!(!s._propertyHash[e]||null==s._propertyHash[e][t.propertyName]);if(t.conditionType==i.notExists)return!(!s._propertyHash[e]||null!=s._propertyHash[e][t.propertyName]);let o;if(t.propertyType==r.nodeName)o=parseFloat(this._viewer.model.getNodeName(e));else if(t.propertyType==r.nodeId)o=e;else{let r;if(s._propertyHash[e]&&(r=s._propertyHash[e][t.propertyName]),null==r)return t.conditionType==i.unequal;o=parseFloat(r)}let n=parseFloat(t.text);if(isNaN(n)||isNaN(o))return!1;if(t.conditionType==i.greaterOrEqual){if(o>=n)return!0}else if(t.conditionType==i.lessOrEqual){if(o<=n)return!0}else if(t.conditionType==i.unequal){if(o!=n)return!0}else if(o==n)return!0;return!1}{let i=t.text.split(","),o="";if(t.propertyType==r.nodeName||t.propertyType==r.relationship)o=this._viewer.model.getNodeName(e);else if(t.propertyType==r.nodeChain)o=this.createChainText(e,this._viewer.model.getRootNode());else if(t.propertyType==r.nodeType)o=Communicator.NodeType[this._viewer.model.getNodeType(e)];else if(t.propertyType==r.nodeColor)if(this._viewer.model.getNodeChildren(e).length>0)o="x";else{let t=await this._viewer.model.getNodesEffectiveFaceColor([e]);o=t.length>0?t[0].r+" "+t[0].g+" "+t[0].b:"x"}else o=t.propertyType==r.nodeId?e.toString():null==s._propertyHash[e]||null==s._propertyHash[e][t.propertyName]?void 0:s._propertyHash[e][t.propertyName];null==o&&(o="");let n=0,a=0,l=0,d=0,h=0;for(let e=0;e<i.length;e++){let s,p;if('"'==i[e][0]||'"'==i[e][1])if(s=!0,'"'==i[e][0])p=i[e].substring(1,i[e].length-1);else{let t=i[e][0];p=i[e].substring(2,i[e].length-1),p=t+p}else p=i[e],s=!1;if(t.propertyType==r.nodeId&&(s=!0),""==p||1==p.length&&("+"==p[0]||"-"==p[0]))return;"+"==p[0]?(a++,s?o.toLowerCase()==p.substring(1).toLowerCase()&&n++:-1!=o.toLowerCase().indexOf(p.substring(1).toLowerCase())&&n++):"-"==p[0]?(l++,s?o.toLowerCase()!=p.substring(1).toLowerCase()&&d++:-1==o.toLowerCase().indexOf(p.substring(1).toLowerCase())&&d++):s?o.toLowerCase()==p.toLowerCase()&&h++:-1!=o.toLowerCase().indexOf(p.toLowerCase())&&h++}return a==n&&l==d&&(h>0||n+d==i.length)}}async _testNodeAgainstConditions(e,t){let i=0,s=!1;t.length>1&&!t[1].and&&(s=!0);for(let o=0;o<t.length;o++){let n;if(t[o].propertyType==r.relationship?"Rel:SpaceBoundary"==t[o].propertyName?n=await this._checkSpaceBoundaryFilter(e,t[o]):"Rel:ContainedIn"==t[o].propertyName&&(n=await this._checkContainedInFilter(e,t[o])):n=t[o].childFilter?await this._testNodeAgainstConditions(e,t[o].childFilter._conditions,s):await this._checkFilter(e,t[o]),0==n){if(!s)break}else i++}return!!(!s&&i==t.length||s&&i>0)}async testOneNodeAgainstConditions(e){return await this._testNodeAgainstConditions(e,this._conditions)}async findAllPropertiesOnNode(e,t,i){let o,n;t?(o=t,n=i):(o=this._conditions,n=[]);for(let t=0;t<o.length;t++)if(o[t].childFilter)await this.findAllPropertiesOnNode(e,o[t].childFilter._conditions,n);else if(o[t].propertyType==r.property){let i=s._propertyHash[e];i[o[t].propertyName]&&n.push({name:o[t].propertyName,value:i[o[t].propertyName]})}return n}async _gatherMatchingNodesRecursive(e,t,i,r){t!=r&&await this._testNodeAgainstConditions(t,e)&&i.push(t);let s=this._viewer.model.getNodeChildren(t);for(let t=0;t<s.length;t++)await this._gatherMatchingNodesRecursive(e,s[t],i,r)}generateString(){let e="";for(let t=0;t<this._conditions.length;t++)t>0&&(e+=" "+(this._conditions[t].and?"AND":"OR")+" "),this._conditions[t].childFilter?e+="("+this._conditions[t].childFilter.generateString()+") ":e+=this._conditions[t].propertyName+" "+s.convertEnumConditionToString(this._conditions[t].conditionType)+" "+this._conditions[t].text;return e}}class o{constructor(){this.and=!0,this.conditionType=i.has,this.propertyType=r.nodeName,this.propertyName="",this.text="",this.childFilter=null}setAndOr(e){this.and=e}getAndOr(){return this.and}setConditionType(e){this.conditionType=e}getConditionType(){return this.conditionType}setPropertyName(e){this.propertyName=e}getPropertyName(){return this.propertyName}setPropertyType(e){this.propertyType=e}getPropertyType(){return this.propertyType}setText(e){this.text=e}getText(){return this.text}setChildFilter(e){this.childFilter=e}getChildFilter(){return this.childFilter}}class n{static _smartFilters=[];static initialize(e){n._viewer=e,n._smartFilters=[]}static addSmartFilter(e,t){n._smartFilters.push({filter:e,isProp:t})}static getSmartFilterNum(){return n._smartFilters.length}static getSmartFilter(e){return n._smartFilters[e].filter}static getIsProp(e){return n._smartFilters[e].isProp}static removeSmartFilter(e){return n._smartFilters.splice(e,1)}static updateSmartFilter(e,t){n._smartFilters[e].filter=t}static updateSmartFilterIsProp(e,t){n._smartFilters[e].isProp=t}static toJSON(){let e=[];for(let t=0;t<n._smartFilters.length;t++)e.push({filter:n._smartFilters[t].filter.toJSON(),isProp:n._smartFilters[t].isProp});return e}static fromJSON(e){n._smartFilters=[];for(let t=0;t<e.length;t++){let i=new s(n._viewer);i.fromJSON(e[t].filter),n.addSmartFilter(i,e[t].isProp)}return e}static async evaluateProperties(e){let t=[];for(let i=0;i<n._smartFilters.length;i++)if(n._smartFilters[i].isProp){let r=n._smartFilters[i].filter;if(await r.testOneNodeAgainstConditions(e)){let i=await r.findAllPropertiesOnNode(e),s=r.getName();""==s&&(s=r.generateString()),t.push({name:s,properties:i})}}return t}}SF=t})();