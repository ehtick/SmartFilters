var SF;(()=>{"use strict";var e={d:(t,r)=>{for(var i in r)e.o(r,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:r[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{SmartFilter:()=>s,SmartFilterCondition:()=>r,SmartFilterConditionType:()=>i,SmartFilterManager:()=>n,SmartFilterPropertyType:()=>o,getVersion:()=>a});class r{constructor(){this.and=!0,this.conditionType=i.has,this.propertyType=o.nodeName,this.propertyName="",this.text="",this.childFilter=null}toJSON(){return{and:this.and,conditionType:this.conditionType,propertyType:this.propertyType,propertyName:JSON.parse(JSON.stringify(this.propertyName)),text:this.text,childFilter:this.childFilter}}fromJSON(e){this.and=e.and,this.conditionType=e.conditionType,this.propertyType=e.propertyType,this.propertyName=e.propertyName,this.text=e.text,this.childFilter=e.childFilter}setAndOr(e){this.and=e}getAndOr(){return this.and}setConditionType(e){this.conditionType=e}getConditionType(){return this.conditionType}setPropertyName(e){this.propertyName=e}getPropertyName(){return this.propertyName}setPropertyType(e){this.propertyType=e}getPropertyType(){return this.propertyType}setText(e){this.text=e}getText(){return this.text}setChildFilter(e){this.childFilter=e}getChildFilter(){return this.childFilter}}const i={has:0,exists:1,notExists:2,greaterOrEqual:3,lessOrEqual:4,equals:5,unequal:6},o={nodeName:0,nodeId:1,nodeChain:2,nodeType:3,nodeColor:4,relationship:5,property:6};class s{static _propertyHash=[];static _allPropertiesHash=[];static containedInSpatialStructureHash=[];static spaceBoundaryHash=[];static convertEnumConditionToString(e){switch(e){case i.has:return"has";case i.exists:return"exists";case i.notExists:return"!exists";case i.greaterOrEqual:return">=";case i.lessOrEqual:return"<=";case i.equals:return"=";case i.unequal:return"≠"}}static convertStringConditionToEnum(e){switch(e){case"has":return i.has;case"exists":return i.exists;case"!exists":return i.notExists;case">=":return i.greaterOrEqual;case"<=":return i.lessOrEqual;case"=":return i.equals;case"≠":return i.unequal}}static convertStringPropertyTypeToEnum(e){switch(e){case"Node Name":return o.nodeName;case"Nodeid":return o.nodeId;case"Node Chain":return o.nodeChain;case"Node Type":return o.nodeType;case"Node Color":return o.nodeColor;case"Rel:ContainedIn":case"Rel:SpaceBoundary":return o.relationship;default:return o.property}}static _getModelTreeIdsRecursive(e,t,r,i){t.push(i.model.getNodeProperties(e)),r.push(e);let o=i.model.getNodeChildren(e);for(let e=0;e<o.length;e++)s._getModelTreeIdsRecursive(o[e],t,r,i)}static initialize(e){s._propertyHash=[],s._allPropertiesHash=[],s.containedInSpatialStructureHash=[],s.spaceBoundaryHash=[];let t=e.model.getLayers();return new Promise((function(r,i){let o=[],n=[];s._getModelTreeIdsRecursive(e.model.getRootNode(),o,n,e),Promise.all(o).then((function(i){for(let r=0;r<i.length;r++){s._propertyHash[n[r]]=i[r];let o=e.model.getNodeLayerId(n[r]);null!=o&&t.size>1&&(null==s._propertyHash[n[r]]&&(s._propertyHash[n[r]]=[]),s._propertyHash[n[r]].LAYER=t.get(o));for(let e in i[r])s._allPropertiesHash[e]=[]}for(let e in s._propertyHash)for(let t in s._propertyHash[e])s._allPropertiesHash[t][s._propertyHash[e][t]]=!0;r()}))}))}constructor(e,t){this._viewer=e,this._limitselectionlist=[],this._conditions=[],this._name="",this._startnode=t||this._viewer.model.getRootNode()}setName(e){this._name=e}getName(){return this._name}getNumConditions(){return this._conditions.length}getCondition(e){return this._conditions[e]}addCondition(e){this._conditions.push(e)}removeCondition(e){this._conditions.splice(e,1)}getAllProperties(){let e=[],t=!1;s._allPropertiesHash.TYPE&&(t=!0);for(let t in s._allPropertiesHash)"TYPE"!=t&&e.push(t);return e.sort(),t&&e.unshift("TYPE"),e}getAllOptionsForProperty(e){return s._allPropertiesHash[e]}fromJSON(e){this._conditions=[];for(let t=0;t<e.conditions.length;t++){let i=new r;i.fromJSON(e.conditions[t]),this._conditions.push(i)}for(let e=0;e<this._conditions.length;e++)if(this._conditions[e].childFilter){let t=new s(this._viewer,this._conditions[e].childFilter.startnode);t.fromJSON(this._conditions[e].childFilter),this._conditions[e].childFilter=t}this._name=e.name}toJSON(){let e=[];for(let t=0;t<this._conditions.length;t++){let r=this._conditions[t].toJSON();this._conditions[t].childFilter&&(r.childFilter=this._conditions[t].childFilter.toJSON()),e.push(r)}return{conditions:e,name:this._name}}limitToNodes(e){this._limitselectionlist=[];for(let t=0;t<e.length;t++)this._limitselectionlist.push(e[t])}getStartNode(){return this._startnode}async apply(){let e=this._conditions,t=this._limitselectionlist;for(let t=0;t<e.length;t++)e[t].text=e[t].text.replace(/&quot;/g,'"');let r=[];if(0==t.length)this._startnode==hwv.model.getRootNode()?await this._gatherMatchingNodesRecursive(e,this._startnode,r,this._startnode):await this._gatherMatchingNodesRecursive(e,this._startnode,r,hwv.model.getNodeParent(this._startnode));else for(let i=0;i<t.length;i++)await this._gatherMatchingNodesRecursive(e,t[i],r,this._viewer.model.getNodeParent(t[i]));return r}createChainText(e,t,r){let i=e,o=[];for(o.push(this._viewer.model.getNodeName(e));;){let e=this._viewer.model.getNodeParent(i);if(null==e||e==t)break;o.push(this._viewer.model.getNodeName(e)),i=e}let s="";for(let e=o.length-1-r;e>=0;e--)s+=e>0?o[e]+"->":o[e];return s}async testOneNodeAgainstConditions(e){return await this._testNodeAgainstConditions(e,this._conditions)}async findAllPropertiesOnNode(e,t,r,i){let n,a,l;t?(n=t,a=r,l=i):(n=this._conditions,a=[],l=[]);for(let t=0;t<n.length;t++)if(n[t].childFilter)await this.findAllPropertiesOnNode(e,n[t].childFilter._conditions,a,l);else if(n[t].propertyType==o.property){let r=s._propertyHash[e];r[n[t].propertyName]&&!l[n[t].propertyName]&&(l[n[t].propertyName]=!0,a.push({name:n[t].propertyName,value:r[n[t].propertyName]}))}return a}generateString(){let e="";for(let t=0;t<this._conditions.length;t++)t>0&&(e+=" "+(this._conditions[t].and?"AND":"OR")+" "),this._conditions[t].childFilter?e+="("+this._conditions[t].childFilter.generateString()+") ":e+=this._conditions[t].propertyName+" "+s.convertEnumConditionToString(this._conditions[t].conditionType)+" "+this._conditions[t].text;return e}async _checkSpaceBoundaryFilter(e,t){let r,i=this._viewer.model.getBimIdFromNode(e);if(s.spaceBoundaryHash[e]?r=s.spaceBoundaryHash[e]:(r=hwv.model.getBimIdRelatingElements(e,i,Communicator.RelationshipType.SpaceBoundary),s.spaceBoundaryHash[e]=r),r.length>0){let i=this._viewer.model.getNodeIdOffset(e);for(let e=0;e<r.length;e++)if(await this._checkFilter(parseInt(r[e])+i,t))return!0}return!1}async _checkContainedInFilter(e,t){let r,i=this._viewer.model.getBimIdFromNode(e);if(s.containedInSpatialStructureHash[e]?r=s.containedInSpatialStructureHash[e]:(r=hwv.model.getBimIdRelatingElements(e,i,Communicator.RelationshipType.ContainedInSpatialStructure),s.containedInSpatialStructureHash[e]=r),r.length>0){let i=this._viewer.model.getNodeIdOffset(e);for(let e=0;e<r.length;e++)if(await this._checkFilter(parseInt(r[e])+i,t))return!0}return!1}async _checkFilter(e,t){if(t.conditionType!=i.has){if(t.conditionType==i.exists)return!(!s._propertyHash[e]||null==s._propertyHash[e][t.propertyName]);if(t.conditionType==i.notExists)return!(!s._propertyHash[e]||null!=s._propertyHash[e][t.propertyName]);let r;if(t.propertyType==o.nodeName)r=parseFloat(this._viewer.model.getNodeName(e));else if(t.propertyType==o.nodeId)r=e;else{let o;if(s._propertyHash[e]&&(o=s._propertyHash[e][t.propertyName]),null==o)return t.conditionType==i.unequal;r=parseFloat(o)}let n=parseFloat(t.text);if(isNaN(n)||isNaN(r))return!1;if(t.conditionType==i.greaterOrEqual){if(r>=n)return!0}else if(t.conditionType==i.lessOrEqual){if(r<=n)return!0}else if(t.conditionType==i.unequal){if(r!=n)return!0}else if(r==n)return!0;return!1}{let r=t.text.split(","),i="";if(t.propertyType==o.nodeName||t.propertyType==o.relationship)i=this._viewer.model.getNodeName(e);else if(t.propertyType==o.nodeChain)i=this.createChainText(e,this._viewer.model.getRootNode());else if(t.propertyType==o.nodeType)i=Communicator.NodeType[this._viewer.model.getNodeType(e)];else if(t.propertyType==o.nodeColor)if(this._viewer.model.getNodeChildren(e).length>0)i="x";else{let t=await this._viewer.model.getNodesEffectiveFaceColor([e]);i=t.length>0?t[0].r+" "+t[0].g+" "+t[0].b:"x"}else i=t.propertyType==o.nodeId?e.toString():null==s._propertyHash[e]||null==s._propertyHash[e][t.propertyName]?void 0:s._propertyHash[e][t.propertyName];null==i&&(i="");let n=0,a=0,l=0,d=0,h=0;for(let e=0;e<r.length;e++){let s,p;if('"'==r[e][0]||'"'==r[e][1])if(s=!0,'"'==r[e][0])p=r[e].substring(1,r[e].length-1);else{let t=r[e][0];p=r[e].substring(2,r[e].length-1),p=t+p}else p=r[e],s=!1;if(t.propertyType==o.nodeId&&(s=!0),""==p||1==p.length&&("+"==p[0]||"-"==p[0]))return;"+"==p[0]?(a++,s?i.toLowerCase()==p.substring(1).toLowerCase()&&n++:-1!=i.toLowerCase().indexOf(p.substring(1).toLowerCase())&&n++):"-"==p[0]?(l++,s?i.toLowerCase()!=p.substring(1).toLowerCase()&&d++:-1==i.toLowerCase().indexOf(p.substring(1).toLowerCase())&&d++):s?i.toLowerCase()==p.toLowerCase()&&h++:-1!=i.toLowerCase().indexOf(p.toLowerCase())&&h++}return a==n&&l==d&&(h>0||n+d==r.length)}}async _testNodeAgainstConditions(e,t){let r=0,i=!1;t.length>1&&!t[1].and&&(i=!0);for(let s=0;s<t.length;s++){let n;if(t[s].propertyType==o.relationship?"Rel:SpaceBoundary"==t[s].propertyName?n=await this._checkSpaceBoundaryFilter(e,t[s]):"Rel:ContainedIn"==t[s].propertyName&&(n=await this._checkContainedInFilter(e,t[s])):n=t[s].childFilter?await this._testNodeAgainstConditions(e,t[s].childFilter._conditions,i):await this._checkFilter(e,t[s]),0==n){if(!i)break}else r++}return!!(!i&&r==t.length||i&&r>0)}async _gatherMatchingNodesRecursive(e,t,r,i){t!=i&&await this._testNodeAgainstConditions(t,e)&&r.push(t);let o=this._viewer.model.getNodeChildren(t);for(let t=0;t<o.length;t++)await this._gatherMatchingNodesRecursive(e,o[t],r,i)}}class n{static _smartFilters=[];static initialize(e){n._viewer=e,n._smartFilters=[]}static addSmartFilter(e,t){n._smartFilters.push({filter:e,isProp:t})}static getSmartFilterNum(){return n._smartFilters.length}static getSmartFilter(e){return n._smartFilters[e].filter}static getIsProp(e){return n._smartFilters[e].isProp}static removeSmartFilter(e){return n._smartFilters.splice(e,1)}static updateSmartFilter(e,t){n._smartFilters[e].filter=t}static updateSmartFilterIsProp(e,t){n._smartFilters[e].isProp=t}static toJSON(){let e=[];for(let t=0;t<n._smartFilters.length;t++)e.push({filter:n._smartFilters[t].filter.toJSON(),isProp:n._smartFilters[t].isProp});return e}static fromJSON(e){n._smartFilters=[];for(let t=0;t<e.length;t++){let r=new s(n._viewer);r.fromJSON(e[t].filter),n.addSmartFilter(r,e[t].isProp)}return e}static async evaluateProperties(e){let t=[];for(let r=0;r<n._smartFilters.length;r++)if(n._smartFilters[r].isProp){let i=n._smartFilters[r].filter;if(await i.testOneNodeAgainstConditions(e)){let r=await i.findAllPropertiesOnNode(e),o=i.getName();""==o&&(o=i.generateString()),t.push({name:o,properties:r})}}return t}}function a(){return"1.0.0"}SF=t})();