var SF;(()=>{"use strict";var e={d:(t,r)=>{for(var i in r)e.o(r,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:r[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{SmartFilter:()=>o,SmartFilterCondition:()=>r,SmartFilterConditionType:()=>i,SmartFilterManager:()=>n,SmartFilterPropertyType:()=>s,getVersion:()=>a});class r{constructor(){this.and=!0,this.conditionType=i.has,this.propertyType=s.nodeName,this.propertyName="",this.text="",this.childFilter=null}toJSON(){return{and:this.and,conditionType:this.conditionType,propertyType:this.propertyType,propertyName:JSON.parse(JSON.stringify(this.propertyName)),text:this.text,childFilter:this.childFilter}}fromJSON(e){this.and=e.and,this.conditionType=e.conditionType,this.propertyType=e.propertyType,this.propertyName=e.propertyName,this.text=e.text,this.childFilter=e.childFilter}setAndOr(e){this.and=e}getAndOr(){return this.and}setConditionType(e){this.conditionType=e}getConditionType(){return this.conditionType}setPropertyName(e){this.propertyName=e}getPropertyName(){return this.propertyName}setPropertyType(e){this.propertyType=e}getPropertyType(){return this.propertyType}setText(e){this.text=e}getText(){return this.text}setChildFilter(e){this.childFilter=e}getChildFilter(){return this.childFilter}}const i={has:0,exists:1,notExists:2,greaterOrEqual:3,lessOrEqual:4,equals:5,unequal:6},s={nodeName:0,nodeId:1,nodeChain:2,nodeType:3,nodeColor:4,relationship:5,property:6};class o{static _propertyHash=[];static _allPropertiesHash=[];static containedInSpatialStructureHash=[];static spaceBoundaryHash=[];static convertEnumConditionToString(e){switch(e){case i.has:return"has";case i.exists:return"exists";case i.notExists:return"!exists";case i.greaterOrEqual:return">=";case i.lessOrEqual:return"<=";case i.equals:return"=";case i.unequal:return"≠"}}static convertStringConditionToEnum(e){switch(e){case"has":return i.has;case"exists":return i.exists;case"!exists":return i.notExists;case">=":return i.greaterOrEqual;case"<=":return i.lessOrEqual;case"=":return i.equals;case"≠":return i.unequal}}static _getModelTreeIdsRecursive(e,t,r,i){t.push(i.model.getNodeProperties(e)),r.push(e);let s=i.model.getNodeChildren(e);for(let e=0;e<s.length;e++)o._getModelTreeIdsRecursive(s[e],t,r,i)}static initialize(e){let t=e.model.getLayers();return new Promise((function(r,i){let s=[],n=[];o._getModelTreeIdsRecursive(e.model.getRootNode(),s,n,e),Promise.all(s).then((function(i){for(let r=0;r<i.length;r++){o._propertyHash[n[r]]=i[r];let s=e.model.getNodeLayerId(n[r]);null!=s&&t.size>1&&(null==o._propertyHash[n[r]]&&(o._propertyHash[n[r]]=[]),o._propertyHash[n[r]].LAYER=t.get(s));for(let e in i[r])o._allPropertiesHash[e]=[]}for(let e in o._propertyHash)for(let t in o._propertyHash[e])o._allPropertiesHash[t][o._propertyHash[e][t]]=!0;r()}))}))}constructor(e,t){this._viewer=e,this._limitselectionlist=[],this._conditions=[],this._name="",this._startnode=t||this._viewer.model.getRootNode()}setName(e){this._name=e}getName(){return this._name}getNumConditions(){return this._conditions.length}getCondition(e){return this._conditions[e]}addCondition(e){this._conditions.push(e)}removeCondition(e){this._conditions.splice(e,1)}getAllProperties(){let e=[],t=!1;o._allPropertiesHash.TYPE&&(t=!0);for(let t in o._allPropertiesHash)"TYPE"!=t&&e.push(t);return e.sort(),t&&e.unshift("TYPE"),e}getAllOptionsForProperty(e){return o._allPropertiesHash[e]}fromJSON(e){this._conditions=[];for(let t=0;t<e.conditions.length;t++){let i=new r;i.fromJSON(e.conditions[t]),this._conditions.push(i)}for(let e=0;e<this._conditions.length;e++)if(this._conditions[e].childFilter){let t=new o(this._viewer,this._conditions[e].childFilter.startnode);t.fromJSON(this._conditions[e].childFilter),this._conditions[e].childFilter=t}this._name=e.name}toJSON(){let e=[];for(let t=0;t<this._conditions.length;t++){let r=this._conditions[t].toJSON();this._conditions[t].childFilter&&(r.childFilter=this._conditions[t].childFilter.toJSON()),e.push(r)}return{conditions:e,name:this._name}}limitToNodes(e){this._limitselectionlist=[];for(let t=0;t<e.length;t++)this._limitselectionlist.push(e[t])}getStartNode(){return this._startnode}async apply(){let e=this._conditions,t=this._limitselectionlist;for(let t=0;t<e.length;t++)e[t].text=e[t].text.replace(/&quot;/g,'"');let r=[];if(0==t.length)this._startnode==hwv.model.getRootNode()?await this._gatherMatchingNodesRecursive(e,this._startnode,r,this._startnode):await this._gatherMatchingNodesRecursive(e,this._startnode,r,hwv.model.getNodeParent(this._startnode));else for(let i=0;i<t.length;i++)await this._gatherMatchingNodesRecursive(e,t[i],r,this._viewer.model.getNodeParent(t[i]));return r}createChainText(e,t){let r=e,i=[];for(i.push(this._viewer.model.getNodeName(e));;){let e=this._viewer.model.getNodeParent(r);if(null==e||e==t)break;i.push(this._viewer.model.getNodeName(e)),r=e}let s="";for(let e=i.length-1;e>=0;e--)s+=e>0?i[e]+"->":i[e];return s}async _checkSpaceBoundaryFilter(e,t){let r,i=this._viewer.model.getBimIdFromNode(e);if(o.spaceBoundaryHash[e]?r=o.spaceBoundaryHash[e]:(r=hwv.model.getBimIdRelatingElements(e,i,Communicator.RelationshipType.SpaceBoundary),o.spaceBoundaryHash[e]=r),r.length>0){let i=this._viewer.model.getNodeIdOffset(e);for(let e=0;e<r.length;e++)if(await this._checkFilter(parseInt(r[e])+i,t))return!0}return!1}async _checkContainedInFilter(e,t){let r,i=this._viewer.model.getBimIdFromNode(e);if(o.containedInSpatialStructureHash[e]?r=o.containedInSpatialStructureHash[e]:(r=hwv.model.getBimIdRelatingElements(e,i,Communicator.RelationshipType.ContainedInSpatialStructure),o.containedInSpatialStructureHash[e]=r),r.length>0){let i=this._viewer.model.getNodeIdOffset(e);for(let e=0;e<r.length;e++)if(await this._checkFilter(parseInt(r[e])+i,t))return!0}return!1}async _checkFilter(e,t){if(t.conditionType!=i.has){if(t.conditionType==i.exists)return!(!o._propertyHash[e]||null==o._propertyHash[e][t.propertyName]);if(t.conditionType==i.notExists)return!(!o._propertyHash[e]||null!=o._propertyHash[e][t.propertyName]);let r;if(t.propertyType==s.nodeName)r=parseFloat(this._viewer.model.getNodeName(e));else if(t.propertyType==s.nodeId)r=e;else{let s;if(o._propertyHash[e]&&(s=o._propertyHash[e][t.propertyName]),null==s)return t.conditionType==i.unequal;r=parseFloat(s)}let n=parseFloat(t.text);if(isNaN(n)||isNaN(r))return!1;if(t.conditionType==i.greaterOrEqual){if(r>=n)return!0}else if(t.conditionType==i.lessOrEqual){if(r<=n)return!0}else if(t.conditionType==i.unequal){if(r!=n)return!0}else if(r==n)return!0;return!1}{let r=t.text.split(","),i="";if(t.propertyType==s.nodeName||t.propertyType==s.relationship)i=this._viewer.model.getNodeName(e);else if(t.propertyType==s.nodeChain)i=this.createChainText(e,this._viewer.model.getRootNode());else if(t.propertyType==s.nodeType)i=Communicator.NodeType[this._viewer.model.getNodeType(e)];else if(t.propertyType==s.nodeColor)if(this._viewer.model.getNodeChildren(e).length>0)i="x";else{let t=await this._viewer.model.getNodesEffectiveFaceColor([e]);i=t.length>0?t[0].r+" "+t[0].g+" "+t[0].b:"x"}else i=t.propertyType==s.nodeId?e.toString():null==o._propertyHash[e]||null==o._propertyHash[e][t.propertyName]?void 0:o._propertyHash[e][t.propertyName];null==i&&(i="");let n=0,a=0,l=0,h=0,p=0;for(let e=0;e<r.length;e++){let o,d;if('"'==r[e][0]||'"'==r[e][1])if(o=!0,'"'==r[e][0])d=r[e].substring(1,r[e].length-1);else{let t=r[e][0];d=r[e].substring(2,r[e].length-1),d=t+d}else d=r[e],o=!1;if(t.propertyType==s.nodeId&&(o=!0),""==d||1==d.length&&("+"==d[0]||"-"==d[0]))return;"+"==d[0]?(a++,o?i.toLowerCase()==d.substring(1).toLowerCase()&&n++:-1!=i.toLowerCase().indexOf(d.substring(1).toLowerCase())&&n++):"-"==d[0]?(l++,o?i.toLowerCase()!=d.substring(1).toLowerCase()&&h++:-1==i.toLowerCase().indexOf(d.substring(1).toLowerCase())&&h++):o?i.toLowerCase()==d.toLowerCase()&&p++:-1!=i.toLowerCase().indexOf(d.toLowerCase())&&p++}return a==n&&l==h&&(p>0||n+h==r.length)}}async _testNodeAgainstConditions(e,t){let r=0,i=!1;t.length>1&&!t[1].and&&(i=!0);for(let o=0;o<t.length;o++){let n;if(t[o].propertyType==s.relationship?"Rel:SpaceBoundary"==t[o].propertyName?n=await this._checkSpaceBoundaryFilter(e,t[o]):"Rel:ContainedIn"==t[o].propertyName&&(n=await this._checkContainedInFilter(e,t[o])):n=t[o].childFilter?await this._testNodeAgainstConditions(e,t[o].childFilter._conditions,i):await this._checkFilter(e,t[o]),0==n){if(!i)break}else r++}return!!(!i&&r==t.length||i&&r>0)}async testOneNodeAgainstConditions(e){return await this._testNodeAgainstConditions(e,this._conditions)}async findAllPropertiesOnNode(e,t,r,i){let n,a,l;t?(n=t,a=r,l=i):(n=this._conditions,a=[],l=[]);for(let t=0;t<n.length;t++)if(n[t].childFilter)await this.findAllPropertiesOnNode(e,n[t].childFilter._conditions,a,l);else if(n[t].propertyType==s.property){let r=o._propertyHash[e];r[n[t].propertyName]&&!l[n[t].propertyName]&&(l[n[t].propertyName]=!0,a.push({name:n[t].propertyName,value:r[n[t].propertyName]}))}return a}async _gatherMatchingNodesRecursive(e,t,r,i){t!=i&&await this._testNodeAgainstConditions(t,e)&&r.push(t);let s=this._viewer.model.getNodeChildren(t);for(let t=0;t<s.length;t++)await this._gatherMatchingNodesRecursive(e,s[t],r,i)}generateString(){let e="";for(let t=0;t<this._conditions.length;t++)t>0&&(e+=" "+(this._conditions[t].and?"AND":"OR")+" "),this._conditions[t].childFilter?e+="("+this._conditions[t].childFilter.generateString()+") ":e+=this._conditions[t].propertyName+" "+o.convertEnumConditionToString(this._conditions[t].conditionType)+" "+this._conditions[t].text;return e}}class n{static _smartFilters=[];static initialize(e){n._viewer=e,n._smartFilters=[]}static addSmartFilter(e,t){n._smartFilters.push({filter:e,isProp:t})}static getSmartFilterNum(){return n._smartFilters.length}static getSmartFilter(e){return n._smartFilters[e].filter}static getIsProp(e){return n._smartFilters[e].isProp}static removeSmartFilter(e){return n._smartFilters.splice(e,1)}static updateSmartFilter(e,t){n._smartFilters[e].filter=t}static updateSmartFilterIsProp(e,t){n._smartFilters[e].isProp=t}static toJSON(){let e=[];for(let t=0;t<n._smartFilters.length;t++)e.push({filter:n._smartFilters[t].filter.toJSON(),isProp:n._smartFilters[t].isProp});return e}static fromJSON(e){n._smartFilters=[];for(let t=0;t<e.length;t++){let r=new o(n._viewer);r.fromJSON(e[t].filter),n.addSmartFilter(r,e[t].isProp)}return e}static async evaluateProperties(e){let t=[];for(let r=0;r<n._smartFilters.length;r++)if(n._smartFilters[r].isProp){let i=n._smartFilters[r].filter;if(await i.testOneNodeAgainstConditions(e)){let r=await i.findAllPropertiesOnNode(e),s=i.getName();""==s&&(s=i.generateString()),t.push({name:s,properties:r})}}return t}}function a(){return"1.0.0"}SF=t})();